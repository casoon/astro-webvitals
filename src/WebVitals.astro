---
/**
 * @casoon/astro-webvitals
 *
 * Comprehensive Web Vitals & Accessibility monitoring for Astro
 * Measures Core Web Vitals, detects WCAG issues, and provides actionable insights
 *
 * @see https://github.com/casoon/astro-webvitals
 */

export interface Props {
	/**
	 * Enable debug overlay (shows metrics and accessibility issues)
	 * @default false
	 */
	debug?: boolean;

	/**
	 * Dock a resizable console log viewer at the bottom of the page
	 * @default false
	 */
	consoleDock?: boolean;

	/**
	 * Optional endpoint to send metrics to
	 * Metrics will be sent as POST requests with JSON payload
	 */
	endpoint?: string;

	/**
	 * Position of debug overlay
	 * @default 'bottom-right'
	 */
	position?: "top-right" | "top-left" | "bottom-right" | "bottom-left";

	/**
	 * Track metrics even in development mode
	 * @default false
	 */
	trackInDev?: boolean;

	/**
	 * Sampling rate (0-1) - only track percentage of users
	 * @default 1 (100% of users)
	 */
	sampleRate?: number;

	/**
	 * Batch metrics before sending (reduces requests)
	 * @default true
	 */
	batchReporting?: boolean;

	/**
	 * Batch interval in milliseconds
	 * @default 5000 (5 seconds)
	 */
	batchInterval?: number;

	/**
	 * Enable WCAG accessibility checking
	 * @default true when debug is enabled
	 */
	checkAccessibility?: boolean;

	/**
	 * Highlight elements on the page that have WCAG issues
	 * @default false
	 */
	highlightAccessibility?: boolean;

	/**
	 * Enable extended metrics (Long Tasks, Memory, Network)
	 * @default false
	 */
	extendedMetrics?: boolean;

	/**
	 * Enable smart detection (rage clicks, dead clicks)
	 * @default false
	 */
	smartDetection?: boolean;

	/**
	 * Performance budget thresholds
	 */
	performanceBudget?: {
		LCP?: number;
		FID?: number;
		CLS?: number;
		FCP?: number;
		TTFB?: number;
		INP?: number;
	};

	/**
	 * Custom headers for endpoint requests
	 */
	headers?: Record<string, string>;

	/**
	 * Session ID for tracking
	 */
	sessionId?: string;

	/**
	 * User ID for tracking
	 */
	userId?: string;
}

const {
	debug = false,
	consoleDock = false,
	endpoint,
	position = "bottom-right",
	trackInDev = false,
	sampleRate = 1,
	batchReporting = true,
	batchInterval = 5000,
	checkAccessibility = debug,
	highlightAccessibility = false,
	extendedMetrics = false,
	smartDetection = false,
	performanceBudget,
	headers = {},
	sessionId,
	userId,
} = Astro.props;

const isDev = import.meta.env.DEV;
const shouldTrack =
	(!isDev || trackInDev || debug || consoleDock || highlightAccessibility) &&
	Math.random() < sampleRate;

// Detect if mobile
const isMobile = typeof window !== "undefined" && window.innerWidth <= 768;

// Position styles will be determined dynamically based on viewport
const desktopPositions = {
	"top-right": "top: 16px; right: 16px;",
	"top-left": "top: 16px; left: 16px;",
	"bottom-right": "bottom: 16px; right: 16px;",
	"bottom-left": "bottom: 16px; left: 16px;",
};

const mobilePosition = "bottom: 0; left: 0; right: 0;"; // Full width at bottom for mobile

const defaultBudgets = {
	LCP: 2500,
	FID: 100,
	CLS: 0.1,
	FCP: 1800,
	TTFB: 800,
	INP: 200,
	...performanceBudget,
};
---

{shouldTrack && (
  <script is:inline define:vars={{
    debug,
    consoleDock,
    endpoint,
    position,
    desktopPositions,
    mobilePosition,
    batchReporting,
    batchInterval,
    checkAccessibility,
    highlightAccessibility,
    extendedMetrics,
    smartDetection,
    performanceBudget: defaultBudgets,
    headers,
    sessionId: sessionId || `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    userId,
    sampleRate
  }}>
    // @casoon/astro-webvitals - Unified Component
    (function() {
      const vitals = {};

      // Browser/Engine detection
      const browserInfo = (() => {
        const ua = navigator.userAgent;
        const isChromium = !!window.chrome;
        const isFirefox = ua.includes("Firefox");
        const isSafari = ua.includes("Safari") && !ua.includes("Chrome");
        const isEdge = ua.includes("Edg/");
        let engine = "unknown";
        if (isChromium || isEdge) engine = "chromium";
        else if (isFirefox) engine = "gecko";
        else if (isSafari) engine = "webkit";
        const supported = {
          LCP: PerformanceObserver.supportedEntryTypes?.includes("largest-contentful-paint") || false,
          FID: PerformanceObserver.supportedEntryTypes?.includes("first-input") || false,
          CLS: PerformanceObserver.supportedEntryTypes?.includes("layout-shift") || false,
          FCP: PerformanceObserver.supportedEntryTypes?.includes("paint") || false,
          INP: PerformanceObserver.supportedEntryTypes?.includes("event") || false
        };
        return { engine, isChromium, isFirefox, isSafari, supported };
      })();
      const metricsBuffer = [];
      const wcagIssues = [];
      let debugContainer;
      let batchTimer;
      let isExpanded = false;
      let activeTab = 'vitals'; // vitals, accessibility, details, console

      // Check if mobile (responsive under 700px)
      let isMobile = window.innerWidth < 700;
      let consoleErrors = [];
      let consoleDockEnabled = false;
      let consoleDockHeight = 160;
      let consoleDockEl;
      let consoleDockLogEl;
      const highlightedNodes = new Set();
      let highlightEnabled = !!highlightAccessibility;
      let seoInfo = null;

      // LCP status flags for UI display
      let lcpUnsupported = false;

      // ============================================================
      // Web Vitals Helper Functions
      // ============================================================

      // Get activation start time for prerendered pages
      function getActivationStart() {
        const navEntry = performance.getEntriesByType('navigation')[0];
        return (navEntry && navEntry.activationStart) || 0;
      }

      // Visibility tracking - important for accurate metrics
      const visibilityWatcher = (() => {
        let firstHiddenTime = document.visibilityState === 'hidden' ? 0 : Infinity;

        const onVisibilityChange = (event) => {
          if (document.visibilityState === 'hidden' && firstHiddenTime === Infinity) {
            firstHiddenTime = event.type === 'visibilitychange' ? event.timeStamp : 0;
          }
        };

        document.addEventListener('visibilitychange', onVisibilityChange, true);
        // Handle page being hidden on unload
        document.addEventListener('prerenderingchange', onVisibilityChange, true);

        return {
          get firstHiddenTime() { return firstHiddenTime; }
        };
      })();

      // BFCache (Back-Forward Cache) restoration handler
      const onBFCacheRestore = (callback) => {
        window.addEventListener('pageshow', (event) => {
          if (event.persisted) {
            callback(event);
          }
        }, true);
      };

      // Run callback once
      const runOnce = (callback) => {
        let called = false;
        return (...args) => {
          if (!called) {
            called = true;
            callback(...args);
          }
        };
      };

      // Schedule during idle or when hidden
      const whenIdleOrHidden = (callback) => {
        const onHidden = () => {
          if (document.visibilityState === 'hidden') {
            callback();
            document.removeEventListener('visibilitychange', onHidden, true);
          }
        };

        if ('requestIdleCallback' in window) {
          requestIdleCallback(() => callback(), { timeout: 500 });
        } else {
          setTimeout(callback, 100);
        }

        document.addEventListener('visibilitychange', onHidden, true);
      };

      // Double requestAnimationFrame for accurate timing after BFCache restore
      const doubleRAF = (callback) => {
        requestAnimationFrame(() => requestAnimationFrame(callback));
      };

      // Track which accessibility issues are expanded
      let expandedIssues = new Set();

      // Listen for viewport changes
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          const newIsMobile = window.innerWidth < 700;
          if (newIsMobile !== isMobile) {
            isMobile = newIsMobile;
            if (debugContainer) {
              updateDebugOverlay();
            }
          }
        }, 250); // Debounce resize events
      });

      // Console log capture
      const originalConsole = {
        log: console.log.bind(console),
        info: console.info.bind(console),
        warn: console.warn.bind(console),
        error: console.error.bind(console)
      };

      function pushConsoleEntry(type, args) {
        const message = args.map(arg =>
          typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
        ).join(' ');

        consoleErrors.push({
          type,
          message,
          timestamp: new Date().toISOString(),
          stack: type === 'error' ? new Error().stack : undefined
        });

        if (consoleErrors.length > 200) {
          consoleErrors.shift(); // Keep max 200 entries
        }
        if (debugContainer && activeTab === 'console') {
          updateDebugOverlay();
        }
        if (consoleDockEnabled) {
          updateConsoleDock();
        }
      }

      ['log', 'info', 'warn', 'error'].forEach(type => {
        console[type] = function(...args) {
          originalConsole[type](...args);
          pushConsoleEntry(type, args);
        };
      });

      // Custom console logging helper
      window.webVitalsLog = {
        info: (...args) => pushConsoleEntry('info', args),
        warn: (...args) => pushConsoleEntry('warn', args),
        error: (...args) => pushConsoleEntry('error', args)
      };

      // Initialize debug overlay
      if (debug) {
        createDebugOverlay();
      }

      if (consoleDock) {
        createConsoleDock();
      }

      function createDebugOverlay() {
        debugContainer = document.createElement('div');
        debugContainer.id = 'astro-webvitals-debug';
        debugContainer.setAttribute('role', 'status');
        debugContainer.setAttribute('aria-label', 'Web Vitals & Accessibility Monitor');
        debugContainer.setAttribute('aria-live', 'polite');

        // Add global styles for animations
        if (!document.getElementById('wv-styles')) {
          const styleSheet = document.createElement('style');
          styleSheet.id = 'wv-styles';
          styleSheet.textContent = `
            @keyframes wv-pulse {
              0%, 100% { opacity: 1; }
              50% { opacity: 0.5; }
            }
            .wv-pulse {
              animation: wv-pulse 1.5s ease-in-out infinite;
            }
            @keyframes wv-spin {
              from { transform: rotate(0deg); }
              to { transform: rotate(360deg); }
            }
            .wv-spin {
              animation: wv-spin 1s linear infinite;
            }
            #astro-webvitals-debug * {
              box-sizing: border-box;
            }
            .wv-a11y-highlight {
              outline: 2px solid #F59E0B;
              outline-offset: 2px;
              position: relative;
              box-shadow: 0 0 0 2px rgba(245, 158, 11, 0.35);
            }
            #astro-webvitals-debug::-webkit-scrollbar {
              width: 4px;
              height: 4px;
            }
            #astro-webvitals-debug::-webkit-scrollbar-track {
              background: rgba(255, 255, 255, 0.05);
              border-radius: 2px;
            }
            #astro-webvitals-debug::-webkit-scrollbar-thumb {
              background: rgba(96, 165, 250, 0.5);
              border-radius: 2px;
            }
            #astro-webvitals-debug::-webkit-scrollbar-thumb:hover {
              background: rgba(96, 165, 250, 0.8);
            }
          `;
          document.head.appendChild(styleSheet);
        }

        // Minimized view by default
        updateDebugOverlay();
        document.body.appendChild(debugContainer);
      }

      function updateDebugOverlay() {
        if (!debugContainer) return;

        const metricsCount = Object.keys(vitals).length;
        const issuesCount = wcagIssues.length;

        // Calculate overall score
        let score = 100;
        if (vitals.LCP > performanceBudget.LCP) score -= 20;
        if (vitals.FID > performanceBudget.FID) score -= 20;
        if (vitals.CLS > performanceBudget.CLS) score -= 20;
        if (vitals.FCP > performanceBudget.FCP) score -= 10;
        if (vitals.TTFB > performanceBudget.TTFB) score -= 10;
        if (issuesCount > 0) score -= Math.min(20, issuesCount * 5);
        score = Math.max(0, score);

        const scoreColor = score >= 80 ? '#10B981' : score >= 60 ? '#F59E0B' : '#EF4444';
        const scoreEmoji = score >= 80 ? '‚úÖ' : score >= 60 ? '‚ö†Ô∏è' : '‚ùå';

        // Mobile-specific styles
        // Adjust position when console dock is open
        let adjustedPosition = desktopPositions[position];
        if (consoleDockEnabled && (position === "bottom-right" || position === "bottom-left")) {
          const bottomOffset = consoleDockHeight + 20;
          adjustedPosition = position === "bottom-right" ? "bottom: " + bottomOffset + "px; right: 16px;" : "bottom: " + bottomOffset + "px; left: 16px;";
        }
        const currentPositionStyle = isMobile ? mobilePosition : adjustedPosition;
        const containerStyles = isMobile ? `
          position: fixed;
          ${mobilePosition}
          background: rgba(17, 24, 39, 0.98);
          color: white;
          border-radius: ${isExpanded ? '16px 16px 0 0' : '0'};
          font-family: 'SF Mono', Monaco, 'Courier New', monospace;
          font-size: 12px;
          z-index: 10000;
          box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-bottom: none;
          transition: all 0.3s ease;
          max-width: 100%;
          height: ${isExpanded ? '60vh' : 'auto'};
          transform: translateY(${isExpanded ? '0' : 'calc(100% - 48px)'});
          overflow: hidden;
        ` : `
          position: fixed;
          ${adjustedPosition}
          background: rgba(17, 24, 39, 0.95);
          color: white;
          border-radius: 12px;
          font-family: 'SF Mono', Monaco, 'Courier New', monospace;
          font-size: 12px;
          z-index: 10000;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          transition: all 0.3s ease;
          width: ${isExpanded ? '420px' : '280px'};
          min-height: ${isExpanded ? '420px' : 'auto'};
          overflow: hidden;
        `;

        debugContainer.innerHTML = `
          <div style="${containerStyles}">
            <!-- Header -->
            <div style="
              padding: 12px 16px;
              border-bottom: 1px solid rgba(255, 255, 255, 0.1);
              cursor: pointer;
              user-select: none;
            " onclick="window.toggleWebVitalsDebug()">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="font-size: 14px;">${scoreEmoji}</span>
                  <span style="font-weight: 600; color: #E5E7EB;">Performance</span>
                  <span style="
                    background: ${scoreColor};
                    color: white;
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-size: 10px;
                    font-weight: bold;
                  ">${score}</span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  ${sampleRate < 1 ? `<span style="font-size: 10px; color: #9CA3AF;">üìä ${(sampleRate * 100).toFixed(0)}%</span>` : ''}
                  <button
                    onclick="event.stopPropagation(); document.getElementById('astro-webvitals-debug').remove();"
                    style="
                      background: transparent;
                      border: none;
                      color: #6B7280;
                      cursor: pointer;
                      padding: 0;
                      width: 16px;
                      height: 16px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      border-radius: 4px;
                      transition: all 0.2s;
                      font-size: 16px;
                      line-height: 1;
                      font-weight: bold;
                    "
                    onmouseover="this.style.color='#EF4444'; this.style.background='rgba(239, 68, 68, 0.1)';"
                    onmouseout="this.style.color='#6B7280'; this.style.background='transparent';"
                    aria-label="Close performance monitor"
                    title="Close (reopens on page reload)"
                  >√ó</button>
                  <span style="
                    transform: rotate(${isExpanded ? '180deg' : '0'});
                    transition: transform 0.3s;
                    font-size: 10px;
                  ">‚ñº</span>
                </div>
              </div>

              ${!isExpanded ? `
                <!-- Minimized Summary -->
                <div style="display: flex; gap: 12px; margin-top: 8px; font-size: 11px; color: #9CA3AF;">
                  ${metricsCount > 0 ? `<span>üìä ${metricsCount} metrics</span>` : '<span>üìä Measuring...</span>'}
                  ${issuesCount > 0 ? `<span style="color: #F59E0B;">‚ö†Ô∏è ${issuesCount} issues</span>` : ''}
                </div>
              ` : ''}
            </div>

            ${isExpanded ? `
              <!-- Tabs -->
              <div style="
                display: flex;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding: 0 16px;
              ">
                <button onclick="window.setWebVitalsTab('vitals')" style="
                  background: none;
                  border: none;
                  color: ${activeTab === 'vitals' ? '#60A5FA' : '#9CA3AF'};
                  padding: 8px 12px;
                  cursor: pointer;
                  font-size: 11px;
                  font-weight: 500;
                  border-bottom: 2px solid ${activeTab === 'vitals' ? '#60A5FA' : 'transparent'};
                  transition: all 0.2s;
                ">Core Vitals</button>

                <button onclick="window.setWebVitalsTab('seo')" style="
                  background: none;
                  border: none;
                  color: ${activeTab === 'seo' ? '#60A5FA' : '#9CA3AF'};
                  padding: 8px 12px;
                  cursor: pointer;
                  font-size: 11px;
                  font-weight: 500;
                  border-bottom: 2px solid ${activeTab === 'seo' ? '#60A5FA' : 'transparent'};
                  transition: all 0.2s;
                ">SEO</button>

                ${checkAccessibility ? `
                  <button onclick="window.setWebVitalsTab('accessibility')" style="
                    background: none;
                    border: none;
                    color: ${activeTab === 'accessibility' ? '#60A5FA' : '#9CA3AF'};
                    padding: 8px 12px;
                    cursor: pointer;
                    font-size: 11px;
                    font-weight: 500;
                    border-bottom: 2px solid ${activeTab === 'accessibility' ? '#60A5FA' : 'transparent'};
                    transition: all 0.2s;
                    position: relative;
                  ">
                    Accessibility
                    ${issuesCount > 0 ? `<span style="
                      position: absolute;
                      top: 4px;
                      right: 4px;
                      background: #EF4444;
                      color: white;
                      border-radius: 10px;
                      padding: 1px 5px;
                      font-size: 9px;
                    ">${issuesCount}</span>` : ''}
                  </button>
                ` : ''}

                ${extendedMetrics || smartDetection ? `
                  <button onclick="window.setWebVitalsTab('details')" style="
                    background: none;
                    border: none;
                    color: ${activeTab === 'details' ? '#60A5FA' : '#9CA3AF'};
                    padding: 8px 12px;
                    cursor: pointer;
                    font-size: 11px;
                    font-weight: 500;
                    border-bottom: 2px solid ${activeTab === 'details' ? '#60A5FA' : 'transparent'};
                    transition: all 0.2s;
                  ">Details</button>
                ` : ''}

                <button onclick="window.setWebVitalsTab('console')" style="
                  background: none;
                  border: none;
                  color: ${activeTab === 'console' ? '#60A5FA' : '#9CA3AF'};
                  padding: 8px 12px;
                  cursor: pointer;
                  font-size: 11px;
                  font-weight: 500;
                  border-bottom: 2px solid ${activeTab === 'console' ? '#60A5FA' : 'transparent'};
                  transition: all 0.2s;
                  position: relative;
                ">
                  Console
                  ${consoleErrors.filter(e => e.type === 'error').length > 0 ? `<span style="
                    position: absolute;
                    top: 4px;
                    right: 4px;
                    background: #EF4444;
                    color: white;
                    border-radius: 10px;
                    padding: 1px 5px;
                    font-size: 9px;
                  ">${consoleErrors.filter(e => e.type === 'error').length}</span>` : ''}
                </button>
              </div>

              <!-- Content -->
              <div id="wv-content" style="padding: 12px 16px; height: ${isMobile ? '60vh' : '400px'}; overflow-y: auto;">
                ${activeTab === 'vitals' ? getVitalsContent() : ''}
                ${activeTab === 'seo' ? getSEOContent() : ''}
                ${activeTab === 'accessibility' ? getAccessibilityContent() : ''}
                ${activeTab === 'details' ? getDetailsContent() : ''}
                ${activeTab === 'console' ? getConsoleContent() : ''}
              </div>

              <!-- Footer -->
              <div style="
                padding: 8px 16px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
              ">
                <a href="https://github.com/casoon/astro-webvitals"
                   target="_blank"
                   rel="noopener noreferrer"
                   style="color: #60A5FA; text-decoration: none; font-size: 10px;">
                  @casoon/astro-webvitals
                </a>
                <button
                  onclick="document.getElementById('astro-webvitals-debug').remove()"
                  aria-label="Close monitor"
                  style="
                    background: none;
                    border: 1px solid #4B5563;
                    color: #9CA3AF;
                    cursor: pointer;
                    padding: 2px 8px;
                    border-radius: 4px;
                    font-size: 10px;
                  ">Close</button>
              </div>
            ` : ''}
          </div>
        `;
      }

      // Helper to get metric rating info
      function getMetricRating(key, value) {
        const thresholds = {
          LCP: { good: 2500, poor: 4000 },
          FID: { good: 100, poor: 300 },
          CLS: { good: 0.1, poor: 0.25 },
          FCP: { good: 1800, poor: 3000 },
          TTFB: { good: 800, poor: 1800 },
          INP: { good: 200, poor: 500 }
        };

        const t = thresholds[key];
        if (!t) return { status: '‚è≥', color: '#9CA3AF', rating: 'measuring', percent: 0 };

        if (value <= t.good) {
          return { status: '‚úÖ', color: '#10B981', rating: 'good', percent: Math.min(100, (value / t.good) * 100) };
        } else if (value <= t.poor) {
          return { status: '‚ö†Ô∏è', color: '#F59E0B', rating: 'needs improvement', percent: 50 + ((value - t.good) / (t.poor - t.good)) * 50 };
        } else {
          return { status: '‚ùå', color: '#EF4444', rating: 'poor', percent: 100 };
        }
      }

      // Render radial gauge SVG
      function renderRadialGauge(score, size = 80) {
        const radius = (size - 8) / 2;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (score / 100) * circumference;
        const color = score >= 80 ? '#10B981' : score >= 60 ? '#F59E0B' : '#EF4444';

        return `
          <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="transform: rotate(-90deg);">
            <circle
              cx="${size/2}" cy="${size/2}" r="${radius}"
              fill="none"
              stroke="rgba(255,255,255,0.1)"
              stroke-width="6"
            />
            <circle
              cx="${size/2}" cy="${size/2}" r="${radius}"
              fill="none"
              stroke="url(#gaugeGradient)"
              stroke-width="6"
              stroke-linecap="round"
              stroke-dasharray="${circumference}"
              stroke-dashoffset="${offset}"
              style="transition: stroke-dashoffset 0.5s ease;"
            />
            <defs>
              <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="${color}" />
                <stop offset="100%" stop-color="${color}88" />
              </linearGradient>
            </defs>
          </svg>
          <div style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            font-size: 18px;
            font-weight: bold;
            color: ${color};
          ">${score}</div>
        `;
      }

      function escapeHTML(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/[&<>"']/g, ch => ({
          '&': '&amp;',
          '<': '&lt;',
          '>': '&gt;',
          '"': '&quot;',
          "'": '&#39;'
        }[ch] || ch));
      }

      function getVitalsContent() {
        // Core Web Vitals (the 3 main ones)
        const coreMetrics = ['LCP', 'FID', 'CLS'];
        // Additional metrics
        const additionalMetrics = ['FCP', 'TTFB', 'INP'];
        // Navigation timing metrics
        const navMetrics = ['DNS', 'TCP', 'DOM', 'LOAD'];

        // Calculate overall score for radial gauge
        let score = 100;
        let measuredCount = 0;
        const hasLCP = typeof vitals.LCP === 'number';

        ['LCP', 'FID', 'CLS', 'FCP', 'TTFB', 'INP'].forEach(key => {
          if (typeof vitals[key] === 'number') {
            measuredCount++;
            const rating = getMetricRating(key, vitals[key]);
            if (rating.rating === 'poor') score -= 15;
            else if (rating.rating === 'needs improvement') score -= 8;
          }
        });
        score = Math.max(0, Math.min(100, score));

        let html = '';

        // Radial gauge header
        html += `
          <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(31, 41, 55, 0.5);
            border-radius: 12px;
          ">
            <div style="position: relative; width: 80px; height: 80px;">
              ${renderRadialGauge(score)}
            </div>
            <div style="margin-left: 16px;">
              <div style="font-size: 12px; color: #9CA3AF; margin-bottom: 4px;">Performance Score</div>
              <div style="font-size: 11px; color: #6B7280;">${measuredCount}/6 metrics measured</div>
              <div style="font-size: 10px; color: #6B7280; margin-top: 2px;">${browserInfo.engine.charAt(0).toUpperCase() + browserInfo.engine.slice(1)} engine</div>
              ${measuredCount < 6 ? `<button onclick="window.triggerWebVitalsInteraction()" style="margin-top: 6px; padding: 4px 10px; background: #3B82F6; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">Trigger FID/INP</button>` : ''}
            </div>
          </div>
        `;

        // Browser compatibility warning
        const unsupportedMetrics = Object.entries(browserInfo.supported).filter(([k, v]) => !v).map(([k]) => k);
        if (unsupportedMetrics.length > 0) {
          html += `
            <div style="
              margin-bottom: 12px;
              padding: 10px 12px;
              background: rgba(251, 191, 36, 0.08);
              border: 1px solid rgba(251, 191, 36, 0.2);
              border-radius: 10px;
              color: #E5E7EB;
              font-size: 11px;
            ">
              <div style="font-weight: 600; color: #FBBF24; margin-bottom: 6px;">Browser Limitation (${browserInfo.engine})</div>
              <div style="color: #9CA3AF; line-height: 1.5;">
                Not supported: ${unsupportedMetrics.join(", ")}<br>
                Use Chrome, Edge or Brave for full metrics.
              </div>
            </div>
          `;
        }

        if (!hasLCP) {
          html += `
            <div style="
              margin-bottom: 12px;
              padding: 10px 12px;
              background: rgba(96, 165, 250, 0.08);
              border: 1px solid rgba(96, 165, 250, 0.2);
              border-radius: 10px;
              color: #E5E7EB;
              font-size: 11px;
            ">
              <div style="font-weight: 600; color: #93C5FD; margin-bottom: 6px;">LCP not observed yet</div>
              <div style="color: #9CA3AF; line-height: 1.5;">
                ${lcpUnsupported ? '‚Ä¢ Browser does not support LCP measurement<br>' : ''}
                ‚Ä¢ LCP is measured on first user interaction or page hide<br>
                ‚Ä¢ Ensure a visible hero (image or large heading) is on the page<br>
                ‚Ä¢ Use same-origin assets or set <code style="color:#E5E7EB;">Timing-Allow-Origin</code> header
              </div>
            </div>
          `;
        }

        // Core Web Vitals section
        html += `<div style="font-size: 11px; color: #60A5FA; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
          <span>üìä</span> Core Web Vitals
        </div>`;

        html += coreMetrics.map(key => renderMetricRow(key)).join('');

        // Additional metrics section
        html += `<div style="font-size: 11px; color: #60A5FA; font-weight: 600; margin: 12px 0 8px 0; display: flex; align-items: center; gap: 6px;">
          <span>üìà</span> Additional Metrics
        </div>`;

        html += additionalMetrics.map(key => renderMetricRow(key)).join('');

        // Navigation timing section (if any are available)
        const hasNavMetrics = navMetrics.some(key => typeof vitals[key] === 'number');
        if (hasNavMetrics) {
          html += `<div style="font-size: 11px; color: #60A5FA; font-weight: 600; margin: 12px 0 8px 0; display: flex; align-items: center; gap: 6px;">
            <span>üåê</span> Navigation Timing
          </div>`;

          html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">`;
          html += navMetrics.map(key => {
            const value = vitals[key];
            if (typeof value !== 'number') return '';
            return `
              <div style="
                padding: 8px;
                background: rgba(31, 41, 55, 0.3);
                border-radius: 6px;
                text-align: center;
              ">
                <div style="font-size: 10px; color: #9CA3AF;">${key}</div>
                <div style="font-size: 14px; color: #E5E7EB; font-weight: 600;">${value}ms</div>
              </div>
            `;
          }).join('');
          html += `</div>`;
        }

        return html;
      }

      function renderMetricRow(key) {
        const value = vitals[key];
        const hasValue = typeof value === 'number';
        const budget = performanceBudget[key];

        // Metric descriptions for better UX
        const metricDescriptions = {
          'LCP': { name: 'Largest Contentful Paint', hint: 'Loading performance' },
          'FID': { name: 'First Input Delay', hint: 'Input responsiveness' },
          'CLS': { name: 'Cumulative Layout Shift', hint: 'Visual stability' },
          'FCP': { name: 'First Contentful Paint', hint: 'Initial render' },
          'TTFB': { name: 'Time to First Byte', hint: 'Server response' },
          'INP': { name: 'Interaction to Next Paint', hint: 'Overall responsiveness' }
        };

        const metricInfo = metricDescriptions[key] || { name: key, hint: '' };

        // Show placeholder for metrics not yet measured
        if (!hasValue) {
          const waitingInfo = {
            'FID': { icon: 'üëÜ', text: 'Click or tap to measure', action: true },
            'INP': { icon: 'üëÜ', text: 'Interact to measure', action: true },
            'CLS': { icon: 'üìê', text: '0.000', isGood: true },
            'LCP': { icon: '‚è≥', text: 'Measuring...', loading: true },
            'FCP': { icon: '‚è≥', text: 'Measuring...', loading: true },
            'TTFB': { icon: '‚è≥', text: 'Measuring...', loading: true }
          };

          const info = waitingInfo[key] || { icon: '‚è≥', text: 'Pending...' };

          // For CLS, show 0 as default (no shifts = good)
          if (key === 'CLS') {
            return `
              <div style="
                padding: 10px;
                margin-bottom: 6px;
                background: rgba(31, 41, 55, 0.4);
                border-radius: 8px;
                border: 1px solid rgba(16, 185, 129, 0.2);
              ">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <span>‚úÖ</span>
                      <span style="font-weight: 600; color: #E5E7EB;">${key}</span>
                    </div>
                    <div style="font-size: 9px; color: #6B7280; margin-top: 2px;">${metricInfo.hint}</div>
                  </div>
                  <div style="text-align: right;">
                    <span style="color: #10B981; font-weight: 600;">0.000</span>
                    <div style="font-size: 9px; color: #10B981;">good</div>
                  </div>
                </div>
                <div style="margin-top: 6px; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden;">
                  <div style="height: 100%; width: 5%; background: #10B981;"></div>
                </div>
              </div>
            `;
          }

          // For interaction-based metrics (FID, INP), show call-to-action
          if (info.action) {
            return `
              <div style="
                padding: 10px;
                margin-bottom: 6px;
                background: rgba(31, 41, 55, 0.3);
                border-radius: 8px;
                border: 1px dashed rgba(96, 165, 250, 0.3);
              ">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <span>${info.icon}</span>
                      <span style="font-weight: 500; color: #9CA3AF;">${key}</span>
                    </div>
                    <div style="font-size: 9px; color: #6B7280; margin-top: 2px;">${metricInfo.hint}</div>
                  </div>
                  <div style="
                    background: rgba(96, 165, 250, 0.1);
                    color: #60A5FA;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 10px;
                  ">${info.text}</div>
                </div>
              </div>
            `;
          }

          // Loading state for other metrics
          return `
            <div style="
              padding: 10px;
              margin-bottom: 6px;
              background: rgba(31, 41, 55, 0.3);
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.05);
              opacity: 0.7;
            ">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span class="wv-pulse">${info.icon}</span>
                    <span style="font-weight: 500; color: #9CA3AF;">${key}</span>
                  </div>
                  <div style="font-size: 9px; color: #6B7280; margin-top: 2px;">${metricInfo.hint}</div>
                </div>
                <span style="color: #6B7280; font-size: 11px;">${info.text}</span>
              </div>
            </div>
          `;
        }

        // Metric has a value - render with rating
        const formatted = key === 'CLS' ? value.toFixed(3) : `${value}ms`;
        const rating = getMetricRating(key, value);
        const exceededBudget = budget && value > budget;

        return `
          <div style="
            padding: 10px;
            margin-bottom: 6px;
            background: rgba(31, 41, 55, 0.5);
            border-radius: 8px;
            border: 1px solid ${exceededBudget ? 'rgba(239, 68, 68, 0.3)' : 'rgba(255, 255, 255, 0.05)'};
          ">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span>${rating.status}</span>
                  <span style="font-weight: 600; color: #E5E7EB;">${key}</span>
                  ${exceededBudget ? '<span style="color: #EF4444; font-size: 9px; margin-left: 4px;">over budget</span>' : ''}
                </div>
                <div style="font-size: 9px; color: #6B7280; margin-top: 2px;">${metricInfo.hint}</div>
              </div>
              <div style="text-align: right;">
                <span style="color: ${rating.color}; font-weight: 600;">${formatted}</span>
                <div style="font-size: 9px; color: ${rating.color};">${rating.rating}</div>
              </div>
            </div>
            <div style="margin-top: 6px; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden;">
              <div style="
                height: 100%;
                width: ${Math.min(100, rating.percent)}%;
                background: linear-gradient(90deg, ${rating.color}, ${rating.color}88);
                transition: width 0.3s ease;
              "></div>
            </div>
          </div>
        `;
      }

      function analyzeSEO() {
        const doc = document;
        const head = doc.head || doc.getElementsByTagName('head')[0];
        const getMeta = (name) => head.querySelector(`meta[name="${name}"]`)?.getAttribute('content')?.trim() || '';
        const getProp = (prop) => head.querySelector(`meta[property="${prop}"]`)?.getAttribute('content')?.trim() || '';

        const title = (doc.title || '').trim();
        const metaDescription = getMeta('description');
        const canonical = head.querySelector('link[rel="canonical"]')?.getAttribute('href') || '';
        const robotsMeta = getMeta('robots');
        const viewport = getMeta('viewport');
        const lang = doc.documentElement.getAttribute('lang') || '';
        const dir = doc.documentElement.getAttribute('dir') || '';

        const headings = Array.from(doc.querySelectorAll('h1, h2, h3, h4, h5, h6')).map(h => ({
          tag: h.tagName.toLowerCase(),
          text: h.textContent.trim(),
          empty: !h.textContent.trim()
        }));
        const h1Count = headings.filter(h => h.tag === 'h1').length;
        const emptyHeadings = headings.filter(h => h.empty);

        const ldScripts = Array.from(doc.querySelectorAll('script[type="application/ld+json"]'));
        const ldResults = ldScripts.map((script, i) => {
          const raw = script.textContent || '';
          let parsed = null;
          let error = null;
          let warnings = [];
          try {
            parsed = JSON.parse(raw);
            const ctx = parsed['@context'];
            const type = parsed['@type'] || (Array.isArray(parsed['@graph']) ? parsed['@graph'][0]?.['@type'] : undefined);
            if (!ctx) warnings.push('Missing @context');
            if (!type) warnings.push('Missing @type');

            const typeLower = (Array.isArray(type) ? type[0] : type || '').toString().toLowerCase();
            const hasField = (key) => parsed[key] || (Array.isArray(parsed['@graph']) && parsed['@graph'].some(item => item[key]));

            if (typeLower.includes('article')) {
              ['headline', 'image', 'author'].forEach(f => { if (!hasField(f)) warnings.push(`Article missing ${f}`); });
            }
            if (typeLower.includes('product')) {
              ['name', 'image', 'offers'].forEach(f => { if (!hasField(f)) warnings.push(`Product missing ${f}`); });
            }
            if (typeLower.includes('organization')) {
              ['name', 'logo'].forEach(f => { if (!hasField(f)) warnings.push(`Organization missing ${f}`); });
            }
            if (typeLower.includes('website')) {
              ['name', 'url'].forEach(f => { if (!hasField(f)) warnings.push(`WebSite missing ${f}`); });
            }
            if (typeLower.includes('breadcrumblist')) {
              if (!hasField('itemListElement')) warnings.push('BreadcrumbList missing itemListElement');
            }
          } catch (e) {
            error = e?.message || 'Invalid JSON';
          }
          return { index: i + 1, raw, parsed, error, warnings };
        });

        const og = {
          title: getProp('og:title'),
          description: getProp('og:description'),
          image: getProp('og:image'),
          url: getProp('og:url'),
          type: getProp('og:type')
        };

        const twitter = {
          card: getMeta('twitter:card'),
          title: getMeta('twitter:title'),
          description: getMeta('twitter:description'),
          image: getMeta('twitter:image')
        };

        const images = Array.from(doc.querySelectorAll('img')).map((img, idx) => ({
          idx,
          src: img.getAttribute('src') || '',
          alt: img.getAttribute('alt') || '',
          width: img.getAttribute('width'),
          height: img.getAttribute('height'),
          naturalWidth: img.naturalWidth,
          naturalHeight: img.naturalHeight
        }));

        const missingAlt = images.filter(i => !i.alt?.trim());
        const missingDimensions = images.filter(i => !i.width && !i.height);
        const heroMissingDimensions = images[0] && (!images[0].width || !images[0].height);

        const hasNoindex = /noindex/i.test(robotsMeta || '');

        return {
          analyzedAt: new Date().toISOString(),
          title,
          metaDescription,
          canonical,
          robotsMeta,
          viewport,
          lang,
          dir,
          h1Count,
          emptyHeadings,
          headings,
          ldResults,
          og,
          twitter,
          images,
          missingAlt,
          missingDimensions,
          heroMissingDimensions,
          hasNoindex,
          xRobots: null,
          indexable: !hasNoindex
        };
      }

      function refreshSEO() {
        preserveContentScroll(() => {
          seoInfo = analyzeSEO();
          updateDebugOverlay();
        });
        fetchIndexabilityHeader();
      }

      function preserveContentScroll(fn) {
        const content = document.getElementById('wv-content');
        const scrollTop = content?.scrollTop || 0;
        fn();
        const newContent = document.getElementById('wv-content');
        if (newContent) newContent.scrollTop = scrollTop;
      }

      async function fetchIndexabilityHeader() {
        try {
          const res = await fetch(window.location.href, { method: 'HEAD' });
          const header = res.headers.get('x-robots-tag');
          if (header && seoInfo) {
            seoInfo.xRobots = header;
            if (/noindex/i.test(header)) {
              seoInfo.indexable = false;
            }
            updateDebugOverlay();
          }
        } catch (e) {
          // ignore network issues
        }
      }

      function formatSEOReport() {
        if (!seoInfo) return 'SEO report not ready';
        const lines = [];
        const yes = '‚úÖ';
        const no = '‚ùå';
        lines.push(`SEO Report - ${new Date().toLocaleString()}`);
        lines.push('');
        lines.push(`Title (${seoInfo.title?.length || 0}): ${seoInfo.title || 'missing'}`);
        lines.push(`Description (${seoInfo.metaDescription?.length || 0}): ${seoInfo.metaDescription || 'missing'}`);
        lines.push(`Canonical: ${seoInfo.canonical || 'missing'}`);
        lines.push(`Robots meta: ${seoInfo.robotsMeta || 'none'}`);
        lines.push(`X-Robots-Tag: ${seoInfo.xRobots || 'n/a'}`);
        lines.push(`Indexable: ${seoInfo.indexable ? yes : no}`);
        lines.push(`Lang: ${seoInfo.lang || 'missing'} | Dir: ${seoInfo.dir || 'unset'}`);
        lines.push(`H1 count: ${seoInfo.h1Count}`);
        if (seoInfo.emptyHeadings?.length) {
          lines.push(`Empty headings: ${seoInfo.emptyHeadings.length}`);
        }
        lines.push('');
        lines.push('Open Graph:');
        lines.push(`  og:title: ${seoInfo.og.title || 'missing'}`);
        lines.push(`  og:description: ${seoInfo.og.description || 'missing'}`);
        lines.push(`  og:image: ${seoInfo.og.image || 'missing'}`);
        lines.push('');
        lines.push('Twitter:');
        lines.push(`  card: ${seoInfo.twitter.card || 'missing'}`);
        lines.push(`  title: ${seoInfo.twitter.title || 'missing'}`);
        lines.push('');
        lines.push(`Structured data blocks: ${seoInfo.ldResults.length}`);
        seoInfo.ldResults.forEach(ld => {
          lines.push(`  #${ld.index}: ${ld.error ? `${no} parse error: ${ld.error}` : 'ok'}`);
          if (ld.warnings?.length) {
            ld.warnings.forEach(w => lines.push(`    ‚ö†Ô∏è ${w}`));
          }
        });
        lines.push('');
        lines.push(`Images missing alt: ${seoInfo.missingAlt.length}`);
        lines.push(`Images missing dimensions: ${seoInfo.missingDimensions.length}`);
        if (seoInfo.heroMissingDimensions) lines.push('Hero image missing dimensions');
        return lines.join('\n');
      }

      function getSEOContent() {
        if (!seoInfo) {
          return `
            <div style="padding: 20px; text-align: center; color: #9CA3AF; font-size: 11px;">
              Collecting SEO data...
            </div>
          `;
        }

        const badge = (text, ok = true) => `<span style="
          display: inline-flex;
          align-items: center;
          gap: 6px;
          background: rgba(255,255,255,0.05);
          color: ${ok ? '#E5E7EB' : '#F59E0B'};
          padding: 4px 8px;
          border-radius: 999px;
          font-size: 10px;
          border: 1px solid rgba(255,255,255,0.08);
        ">${ok ? '‚úÖ' : '‚ö†Ô∏è'} ${text}</span>`;

        const listItem = (label, value, ok = true) => `
          <div style="display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 11px;">
            <span style="color: #9CA3AF;">${label}</span>
            <span style="color: ${ok ? '#E5E7EB' : '#F59E0B'};">${value || '‚Äî'}</span>
          </div>
        `;

        const ogMissing = ['title', 'description', 'image'].filter(k => !seoInfo.og[k]);
        const twMissing = ['card', 'title', 'description', 'image'].filter(k => !seoInfo.twitter[k]);

        const headingsOutline = seoInfo.headings.slice(0, 8).map(h => `${h.tag.toUpperCase()}: ${escapeHTML(h.text || '(empty)')}`).join('<br>');

        return `
          <div style="display: grid; gap: 12px;">
            <div style="padding: 10px; background: rgba(31,41,55,0.4); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="color: #E5E7EB; font-weight: 600; font-size: 12px;">Indexability</div>
                <span style="
                  padding: 4px 10px;
                  border-radius: 999px;
                  background: ${seoInfo.indexable ? 'rgba(16,185,129,0.2)' : 'rgba(239,68,68,0.2)'};
                  color: ${seoInfo.indexable ? '#10B981' : '#EF4444'};
                  font-size: 11px;
                ">${seoInfo.indexable ? 'Indexable' : 'Noindex'}</span>
              </div>
              ${listItem('Robots meta', seoInfo.robotsMeta || '‚Äî', !seoInfo.hasNoindex)}
              ${listItem('X-Robots-Tag', seoInfo.xRobots || '‚Äî', seoInfo.xRobots ? !/noindex/i.test(seoInfo.xRobots) : true)}
              ${listItem('Canonical', seoInfo.canonical || '‚Äî', !!seoInfo.canonical)}
            </div>

            <div style="padding: 10px; background: rgba(31,41,55,0.4); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);">
              <div style="color: #E5E7EB; font-weight: 600; font-size: 12px; margin-bottom: 8px;">Basics</div>
              ${listItem('Title', seoInfo.title || 'Missing', !!seoInfo.title)}
              ${listItem('Title length', `${seoInfo.title?.length || 0} chars`, seoInfo.title?.length >= 30 && seoInfo.title?.length <= 65)}
              ${listItem('Description', seoInfo.metaDescription || 'Missing', !!seoInfo.metaDescription)}
              ${listItem('Description length', `${seoInfo.metaDescription?.length || 0} chars`, seoInfo.metaDescription?.length >= 50 && seoInfo.metaDescription?.length <= 160)}
              ${listItem('Viewport', seoInfo.viewport || 'Missing', !!seoInfo.viewport)}
              ${listItem('Lang / Dir', `${seoInfo.lang || 'missing'} / ${seoInfo.dir || 'unset'}`, !!seoInfo.lang)}
            </div>

            <div style="padding: 10px; background: rgba(31,41,55,0.4); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);">
              <div style="color: #E5E7EB; font-weight: 600; font-size: 12px; margin-bottom: 8px;">Headings</div>
              <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                ${badge(`H1 count: ${seoInfo.h1Count}`, seoInfo.h1Count === 1)}
                ${seoInfo.emptyHeadings.length ? badge(`Empty headings: ${seoInfo.emptyHeadings.length}`, false) : ''}
              </div>
              <div style="color: #9CA3AF; font-size: 10px; line-height: 1.5;">${headingsOutline || 'No headings found'}</div>
            </div>

            <div style="padding: 10px; background: rgba(31,41,55,0.4); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);">
              <div style="color: #E5E7EB; font-weight: 600; font-size: 12px; margin-bottom: 8px;">Open Graph / Twitter</div>
              <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 8px;">
                ${badge('OG title', !!seoInfo.og.title)}
                ${badge('OG desc', !!seoInfo.og.description)}
                ${badge('OG image', !!seoInfo.og.image)}
                ${badge('Twitter card', !!seoInfo.twitter.card)}
                ${badge('Twitter title', !!seoInfo.twitter.title)}
              </div>
              ${(ogMissing.length || twMissing.length) ? `<div style="color: #F59E0B; font-size: 10px;">Missing: ${[...ogMissing, ...twMissing].join(', ')}</div>` : ''}
            </div>

            <div style="padding: 10px; background: rgba(31,41,55,0.4); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="color: #E5E7EB; font-weight: 600; font-size: 12px;">Structured Data</div>
                <span style="color: #9CA3AF; font-size: 10px;">${seoInfo.ldResults.length} block(s)</span>
              </div>
              ${seoInfo.ldResults.length === 0 ? `
                <div style="color: #9CA3AF; font-size: 11px;">No JSON-LD blocks found.</div>
              ` : `
                <div style="display: flex; flex-direction: column; gap: 6px;">
                  ${seoInfo.ldResults.slice(0,3).map(ld => `
                    <div style="
                      padding: 8px;
                      background: rgba(255,255,255,0.04);
                      border-radius: 6px;
                      border: 1px solid rgba(255,255,255,0.06);
                      color: ${ld.error ? '#F59E0B' : '#E5E7EB'};
                      font-size: 11px;
                    ">
                      #${ld.index}: ${ld.error ? `Parse error: ${escapeHTML(ld.error)}` : 'Valid JSON'}
                      ${ld.warnings?.length ? `<div style="color: #F59E0B; font-size: 10px; margin-top: 4px;">Warnings: ${ld.warnings.map(escapeHTML).join(', ')}</div>` : ''}
                    </div>
                  `).join('')}
                  ${seoInfo.ldResults.length > 3 ? `<div style="color: #6B7280; font-size: 10px;">+ ${seoInfo.ldResults.length - 3} more</div>` : ''}
                </div>
              `}
            </div>

            <div style="padding: 10px; background: rgba(31,41,55,0.4); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08);">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                <div style="color: #E5E7EB; font-weight: 600; font-size: 12px;">Images</div>
                <span style="color: #9CA3AF; font-size: 10px;">${seoInfo.images.length} found</span>
              </div>
              <div style="display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 6px;">
                ${badge(`Missing alt: ${seoInfo.missingAlt.length}`, seoInfo.missingAlt.length === 0)}
                ${badge(`Missing dimensions: ${seoInfo.missingDimensions.length}`, seoInfo.missingDimensions.length === 0)}
                ${badge('Hero dims ok', !seoInfo.heroMissingDimensions)}
              </div>
              ${(seoInfo.missingAlt.length || seoInfo.missingDimensions.length) ? `
                <div style="color: #9CA3AF; font-size: 10px;">First few issues:</div>
                <div style="display: flex; flex-direction: column; gap: 4px; margin-top: 4px;">
                  ${seoInfo.missingAlt.slice(0,2).map(img => `
                    <div style="font-size: 10px; color: #F59E0B;">#${img.idx + 1} missing alt (${escapeHTML(img.src || 'src?')})</div>
                  `).join('')}
                  ${seoInfo.missingDimensions.slice(0,2).map(img => `
                    <div style="font-size: 10px; color: #F59E0B;">#${img.idx + 1} missing width/height (${escapeHTML(img.src || 'src?')})</div>
                  `).join('')}
                </div>
              ` : ''}
            </div>

            <div style="padding: 10px; background: rgba(31,41,55,0.4); border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); display: flex; gap: 8px; align-items: center; justify-content: space-between;">
              <div style="color: #9CA3AF; font-size: 11px;">Copy a shareable SEO report</div>
              <button onclick="window.copySEOReport()" style="
                background: #4B5563;
                border: 1px solid #6B7280;
                color: #E5E7EB;
                padding: 6px 10px;
                border-radius: 6px;
                font-size: 11px;
                cursor: pointer;
              ">Copy SEO Report</button>
            </div>
          </div>
        `;
      }

      function getAccessibilityContent() {
        if (wcagIssues.length === 0) {
          return `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 32px; margin-bottom: 8px;">‚úÖ</div>
              <div style="color: #10B981; font-weight: 500;">No accessibility issues detected</div>
              <div style="color: #6B7280; font-size: 11px; margin-top: 4px;">WCAG 2.1 Level AA compliant</div>
            </div>
          `;
        }

        // Group issues by type with full details
        const groupedIssues = wcagIssues.reduce((acc, issue, index) => {
          if (!acc[issue.type]) {
            acc[issue.type] = [];
          }
          acc[issue.type].push({ ...issue, id: index });
          return acc;
        }, {});

        const issueInfo = {
          'missing-alt': {
            icon: 'üñºÔ∏è',
            label: 'Missing Alt Text',
            description: 'Images should have descriptive alt text for screen readers.',
            link: 'https://web.dev/image-alt/'
          },
          'low-contrast': {
            icon: 'üé®',
            label: 'Low Contrast',
            description: 'Text should have sufficient contrast ratio for readability.',
            link: 'https://web.dev/color-contrast/'
          },
          'missing-label': {
            icon: 'üè∑Ô∏è',
            label: 'Missing Labels',
            description: 'Form elements and interactive controls need accessible labels.',
            link: 'https://web.dev/label/'
          },
          'missing-heading': {
            icon: 'üìù',
            label: 'Heading Issues',
            description: 'Heading levels should follow a logical hierarchy without skipping levels.',
            link: 'https://web.dev/heading-order/'
          },
          'keyboard': {
            icon: '‚å®Ô∏è',
            label: 'Keyboard Navigation',
            description: 'All interactive elements must be accessible via keyboard.',
            link: 'https://web.dev/keyboard-access/'
          }
        };

        return `
          <div style="padding: 4px;">
            <!-- Summary header -->
            <div style="
              margin-bottom: 12px;
              padding: 10px;
              background: rgba(245, 158, 11, 0.1);
              border-radius: 8px;
              border: 1px solid rgba(245, 158, 11, 0.3);
              display: flex;
              align-items: center;
              justify-content: space-between;
            ">
              <div>
                <div style="font-size: 12px; font-weight: 600; color: #F59E0B;">
                  ‚ö†Ô∏è ${wcagIssues.length} Issue${wcagIssues.length !== 1 ? 's' : ''} Found
                </div>
                <div style="font-size: 10px; color: #9CA3AF; margin-top: 2px;">
                  Click to expand details
                </div>
              </div>
              <div style="
                background: rgba(245, 158, 11, 0.2);
                color: #F59E0B;
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
              ">${Object.keys(groupedIssues).length} categories</div>
            </div>

            <!-- Issue categories -->
            ${Object.entries(groupedIssues).map(([type, issues]) => {
              const info = issueInfo[type] || { icon: '‚ùì', label: type, description: '', link: '' };
              const isExpanded = expandedIssues.has(type);

              return `
                <div style="margin-bottom: 8px;">
                  <!-- Category header (clickable) -->
                  <div
                    onclick="window.toggleAccessibilityIssue('${type}')"
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 10px 12px;
                      background: ${isExpanded ? 'rgba(245, 158, 11, 0.15)' : 'rgba(31, 41, 55, 0.5)'};
                      border-radius: ${isExpanded ? '8px 8px 0 0' : '8px'};
                      border-left: 3px solid ${issues.length > 3 ? '#EF4444' : '#F59E0B'};
                      cursor: pointer;
                      transition: all 0.2s;
                    "
                  >
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span>${info.icon}</span>
                      <span style="color: #E5E7EB; font-size: 12px; font-weight: 500;">${info.label}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span style="
                        background: ${issues.length > 3 ? 'rgba(239, 68, 68, 0.2)' : 'rgba(245, 158, 11, 0.2)'};
                        color: ${issues.length > 3 ? '#EF4444' : '#F59E0B'};
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 600;
                      ">${issues.length}</span>
                      <span style="
                        transform: rotate(${isExpanded ? '180deg' : '0deg'});
                        transition: transform 0.2s;
                        font-size: 10px;
                        color: #9CA3AF;
                      ">‚ñº</span>
                    </div>
                  </div>

                  <!-- Expanded details -->
                  ${isExpanded ? `
                    <div style="
                      background: rgba(31, 41, 55, 0.3);
                      border-radius: 0 0 8px 8px;
                      border: 1px solid rgba(255, 255, 255, 0.05);
                      border-top: none;
                      padding: 10px;
                    ">
                      <!-- Description -->
                      <div style="
                        font-size: 11px;
                        color: #E5E7EB;
                        margin-bottom: 10px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                      ">
                        ${info.description}
                        ${info.link ? `<a href="${info.link}" target="_blank" rel="noopener noreferrer" style="color: #93C5FD; margin-left: 6px; text-decoration: underline;">Learn more ‚Üí</a>` : ''}
                      </div>

                      <!-- Individual issues -->
                      ${issues.slice(0, 10).map((issue, i) => `
                        <div style="
                          font-size: 10px;
                          color: #E5E7EB;
                          padding: 6px 8px;
                          margin-bottom: 4px;
                          background: rgba(31, 41, 55, 0.5);
                          border-radius: 4px;
                          font-family: 'SF Mono', Monaco, monospace;
                          word-break: break-all;
                        ">
                          <span style="color: #6B7280;">${i + 1}.</span>
                          <span style="color: #F59E0B;">${escapeHTML(issue.element || 'Element')}</span>
                          ${issue.message ? `<div style="color: #9CA3AF; margin-top: 2px; font-size: 9px;">${issue.message}</div>` : ''}
                        </div>
                      `).join('')}

                      ${issues.length > 10 ? `
                        <div style="font-size: 10px; color: #6B7280; text-align: center; padding: 4px;">
                          ... and ${issues.length - 10} more
                        </div>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}

            <!-- Tips -->
            <div style="
              margin-top: 12px;
              padding: 10px;
              background: rgba(96, 165, 250, 0.1);
              border-radius: 8px;
              border: 1px solid rgba(96, 165, 250, 0.2);
            ">
              <div style="font-size: 10px; color: #60A5FA; font-weight: 500; margin-bottom: 4px;">üí° Quick Wins</div>
              <div style="font-size: 10px; color: #9CA3AF;">
                ${wcagIssues.some(i => i.type === 'missing-alt') ? '‚Ä¢ Add alt text to images for screen readers<br>' : ''}
                ${wcagIssues.some(i => i.type === 'missing-label') ? '‚Ä¢ Add labels to form inputs and buttons<br>' : ''}
                ${wcagIssues.some(i => i.type === 'missing-heading') ? '‚Ä¢ Fix heading hierarchy (h1 ‚Üí h2 ‚Üí h3)' : ''}
              </div>
            </div>
          </div>
        `;
      }

      function getConsoleContent() {
        return `
          <div style="padding: 8px; display: flex; flex-direction: column; gap: 12px;">
            <div style="
              padding: 10px;
              background: rgba(31, 41, 55, 0.4);
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.08);
              display: grid;
              grid-template-columns: 1fr;
              gap: 8px;
            ">
              <div style="font-size: 11px; color: #9CA3AF; text-transform: uppercase; letter-spacing: 0.03em;">Quick Actions</div>
              <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                <button onclick="event.stopPropagation(); window.toggleConsoleDock()" style="
                  background: ${consoleDockEnabled ? '#10B981' : '#4B5563'};
                  border: none;
                  color: white;
                  padding: 6px 10px;
                  border-radius: 6px;
                  font-size: 11px;
                  cursor: pointer;
                ">${consoleDockEnabled ? 'Close Console Dock' : 'Open Console Dock'}</button>
                <button onclick="window.toggleHighlightIssues()" style="
                  background: ${highlightEnabled ? 'rgba(239, 68, 68, 0.15)' : '#1F2937'};
                  border: 1px solid ${highlightEnabled ? 'rgba(239, 68, 68, 0.4)' : '#374151'};
                  color: ${highlightEnabled ? '#FCA5A5' : '#E5E7EB'};
                  padding: 6px 10px;
                  border-radius: 6px;
                  font-size: 11px;
                  cursor: pointer;
                ">${highlightEnabled ? 'Hide WCAG Highlights' : 'Show WCAG Highlights'}</button>
                <button onclick="window.clearConsoleErrors()" style="
                  background: #4B5563;
                  border: none;
                  color: white;
                  padding: 6px 10px;
                  border-radius: 6px;
                  font-size: 11px;
                  cursor: pointer;
                ">Clear Messages</button>
              </div>
              <div style="font-size: 10px; color: #6B7280;">
                Console output is captured automatically. Open the dock to view logs; it sits at the bottom of the page and can be resized by dragging the handle upward.
              </div>
            </div>
          </div>
        `;
      }

      function getDetailsContent() {
        let content = '<div style="padding: 8px;">';

        // Page Info
        content += `
          <div style="margin-bottom: 16px;">
            <div style="font-weight: 500; color: #60A5FA; margin-bottom: 8px; font-size: 11px;">üìä Session Info</div>
            <div style="padding: 8px; background: rgba(31, 41, 55, 0.5); border-radius: 6px; font-size: 10px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="color: #9CA3AF;">URL</span>
                <span style="color: #E5E7EB; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${window.location.pathname}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="color: #9CA3AF;">Viewport</span>
                <span style="color: #E5E7EB;">${window.innerWidth} √ó ${window.innerHeight}</span>
              </div>
              ${sampleRate < 1 ? `
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: #9CA3AF;">Sampling Rate</span>
                  <span style="color: #E5E7EB;">${(sampleRate * 100).toFixed(0)}%</span>
                </div>
              ` : ''}
            </div>
          </div>
        `;

        // Extended metrics
        if (extendedMetrics && performance.memory) {
          const used = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
          const total = (performance.memory.totalJSHeapSize / 1048576).toFixed(1);
          const percent = ((performance.memory.usedJSHeapSize / performance.memory.totalJSHeapSize) * 100).toFixed(0);

          content += `
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 500; color: #60A5FA; margin-bottom: 8px; font-size: 11px;">üíæ Memory</div>
              <div style="padding: 8px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 4px;">
                  <span style="color: #9CA3AF;">JS Heap</span>
                  <span style="color: #E5E7EB;">${used} / ${total} MB (${percent}%)</span>
                </div>
                <div style="height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden;">
                  <div style="height: 100%; width: ${percent}%; background: ${percent < 70 ? '#10B981' : percent < 90 ? '#F59E0B' : '#EF4444'};"></div>
                </div>
              </div>
            </div>
          `;
        }

        if (navigator.connection) {
          const conn = navigator.connection;
          const connectionQuality = conn.effectiveType === '4g' ? 'üü¢' :
                                   conn.effectiveType === '3g' ? 'üü°' :
                                   conn.effectiveType === '2g' ? 'üü†' : 'üî¥';

          content += `
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 500; color: #60A5FA; margin-bottom: 8px; font-size: 11px;">üåê Network</div>
              <div style="padding: 8px; background: rgba(31, 41, 55, 0.5); border-radius: 6px; font-size: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="color: #9CA3AF;">Connection</span>
                  <span style="color: #E5E7EB;">${connectionQuality} ${conn.effectiveType || 'unknown'}</span>
                </div>
                ${conn.rtt ? `
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="color: #9CA3AF;">Latency</span>
                    <span style="color: #E5E7EB;">${conn.rtt}ms</span>
                  </div>
                ` : ''}
                ${conn.downlink ? `
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: #9CA3AF;">Speed</span>
                    <span style="color: #E5E7EB;">${conn.downlink} Mbps</span>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }

        // Config info
        if (endpoint || batchReporting) {
          content += `
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 500; color: #60A5FA; margin-bottom: 8px; font-size: 11px;">‚öôÔ∏è Configuration</div>
              <div style="padding: 8px; background: rgba(31, 41, 55, 0.5); border-radius: 6px; font-size: 10px;">
                ${endpoint ? `
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="color: #9CA3AF;">Analytics</span>
                    <span style="color: #10B981;">‚úÖ Active</span>
                  </div>
                ` : ''}
                ${batchReporting ? `
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: #9CA3AF;">Batching</span>
                    <span style="color: #E5E7EB;">Every ${batchInterval/1000}s</span>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }

        content += '</div>';
        return content;
      }

      // Global functions for overlay interaction
      window.toggleWebVitalsDebug = function() {
        isExpanded = !isExpanded;
        updateDebugOverlay();
      };


      window.triggerWebVitalsInteraction = function() {
        // Trigger a real click event to measure FID/INP
        const btn = document.createElement("button");
        btn.style.cssText = "position:fixed;top:-100px;left:-100px;opacity:0;pointer-events:none;";
        document.body.appendChild(btn);
        btn.click();
        setTimeout(() => btn.remove(), 100);
        // Update overlay after metrics are collected
        setTimeout(() => updateDebugOverlay(), 200);
      };

      window.setWebVitalsTab = function(tab) {
        activeTab = tab;
        updateDebugOverlay();
      };

      window.clearConsoleErrors = function() {
        consoleErrors.length = 0;
        updateDebugOverlay();
        if (consoleDockEnabled) updateConsoleDock();
      };

      window.copyConsoleLine = function(index) {
        const log = consoleErrors[index];
        if (log) {
          const text = "[" + log.type.toUpperCase() + "] " + new Date(log.timestamp).toLocaleTimeString() + " - " + log.message;
          navigator.clipboard.writeText(text).then(() => {
            console.log("Copied to clipboard");
          });
        }
      };

      window.copyAllConsoleLogs = function() {
        const text = consoleErrors.map(log => 
          "[" + log.type.toUpperCase() + "] " + new Date(log.timestamp).toLocaleTimeString() + " - " + log.message
        ).join("\n");
        navigator.clipboard.writeText(text).then(() => {
          console.log("All logs copied to clipboard");
        });
      };


      window.toggleAccessibilityIssue = function(type) {
        if (expandedIssues.has(type)) {
          expandedIssues.delete(type);
        } else {
          expandedIssues.add(type);
        }
        updateDebugOverlay();
      };

      window.copySEOReport = async function() {
        const text = formatSEOReport();
        try {
          if (navigator.clipboard?.writeText) {
            await navigator.clipboard.writeText(text);
          } else {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
          }
        } catch (e) {
          console.warn('[@casoon/astro-webvitals] Failed to copy SEO report', e);
        }
      };

      window.toggleHighlightIssues = function() {
        highlightEnabled = !highlightEnabled;
        if (!highlightEnabled) {
          clearAccessibilityHighlights();
        }
        if (checkAccessibility) {
          checkWCAG();
        }
        updateDebugOverlay();
      };

      function clearAccessibilityHighlights() {
        highlightedNodes.forEach(node => {
          if (node && node.classList) {
            node.classList.remove('wv-a11y-highlight');
          }
        });
        highlightedNodes.clear();
      }

      // Console dock controls
      window.toggleConsoleDock = function(force) {
        console.log("[WV] toggleConsoleDock called, current:", consoleDockEnabled, "force:", force);
        const shouldEnable = typeof force === 'boolean' ? force : !consoleDockEnabled;
        if (shouldEnable) {
          createConsoleDock();
          updateDebugOverlay();
        } else {
          destroyConsoleDock();
          updateDebugOverlay();
        }
      };

      function createConsoleDock() {
        if (consoleDockEl) return;
        consoleDockEnabled = true;

        consoleDockEl = document.createElement('div');
        consoleDockEl.id = 'astro-webvitals-console-dock';
        consoleDockEl.style.cssText = `
          position: fixed;
          bottom: 0;
          left: 0;
          width: 100%;
          height: ${consoleDockHeight}px;
          min-height: 120px;
          max-height: 75vh;
          background: rgba(12, 17, 30, 0.98);
          color: #E5E7EB;
          font-family: 'SF Mono', Monaco, 'Courier New', monospace;
          z-index: 9999;
          box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.45);
          border-top: 1px solid rgba(255, 255, 255, 0.08);
          display: flex;
          flex-direction: column;
          backdrop-filter: blur(6px);
        `;

        const resizeHandle = document.createElement('div');
        resizeHandle.style.cssText = `
          height: 10px;
          cursor: ns-resize;
          background: linear-gradient(180deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
          border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        `;
        resizeHandle.title = 'Ziehen um die H√∂he anzupassen';
        resizeHandle.addEventListener('pointerdown', startDockResize);

        const header = document.createElement('div');
        header.style.cssText = `
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 6px 12px;
          border-bottom: 1px solid rgba(255, 255, 255, 0.05);
          font-size: 12px;
        `;
        header.innerHTML = `
          <div style="display: flex; align-items: center; gap: 8px; color: #9CA3AF;">
            <span>ü™µ</span>
            <span style="color: #E5E7EB; font-weight: 600;">Browser Console</span>
            <span style="font-size: 11px;">${consoleErrors.length} Logs</span>
          </div>
          <div style="display: flex; align-items: center; gap: 6px;">
            <button
              onclick="window.clearConsoleErrors()"
              style="
                background: #1F2937;
                border: 1px solid #374151;
                color: #E5E7EB;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
              "
            >Clear</button>
            <button
              onclick="window.copyAllConsoleLogs()"
              style="
                background: #1F2937;
                border: 1px solid #374151;
                color: #E5E7EB;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
              "
            >Copy All</button>
            <button
              onclick="event.stopPropagation(); window.toggleConsoleDock(false)"
              style="
                background: #111827;
                border: 1px solid #374151;
                color: #9CA3AF;
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 11px;
                cursor: pointer;
              "
            >Close</button>
          </div>
        `;

        consoleDockLogEl = document.createElement('div');
        consoleDockLogEl.style.cssText = `
          flex: 1;
          overflow: auto;
          padding: 8px 12px;
          font-size: 11px;
          line-height: 1.4;
        `;

        consoleDockEl.appendChild(resizeHandle);
        consoleDockEl.appendChild(header);
        consoleDockEl.appendChild(consoleDockLogEl);
        document.body.appendChild(consoleDockEl);
        updateConsoleDock();
      }

      function updateConsoleDock() {
        if (!consoleDockEl || !consoleDockLogEl) return;

        const typeColors = {
          error: '#F87171',
          warn: '#FBBF24',
          info: '#60A5FA',
          log: '#9CA3AF'
        };

        const counter = consoleDockEl.querySelector('span[style*="Logs"]');
        if (counter) counter.innerHTML = `${consoleErrors.length} Logs`;

        consoleDockLogEl.innerHTML = consoleErrors.slice(-150).map((log, index) => `
          <div style="
            margin-bottom: 6px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 6px;
            border-left: 3px solid ${typeColors[log.type] || '#6B7280'};
          ">
            <div style="display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 10px; color: #9CA3AF;">
              <span style="color: ${typeColors[log.type] || '#9CA3AF'};">${(log.type || 'log').toUpperCase()}</span>
              <span>${new Date(log.timestamp).toLocaleTimeString()}</span>
              <button onclick="window.copyConsoleLine(${index})" style="background: transparent; border: 1px solid #4B5563; color: #9CA3AF; padding: 2px 6px; border-radius: 4px; font-size: 9px; cursor: pointer;" title="Copy this line">Copy</button>
            </div>
            <pre style="margin: 0; color: #E5E7EB; white-space: pre-wrap; word-break: break-word; font-family: 'SF Mono', Monaco, 'Courier New', monospace;">${log.message}</pre>
          </div>
        `).join('');

        consoleDockLogEl.scrollTop = consoleDockLogEl.scrollHeight;
      }

      function startDockResize(event) {
        event.preventDefault();
        const startY = event.clientY;
        const startHeight = consoleDockHeight;

        function onMove(e) {
          const delta = startY - e.clientY;
          const minHeight = 120;
          const maxHeight = Math.min(window.innerHeight * 0.8, 700);
          consoleDockHeight = Math.max(minHeight, Math.min(maxHeight, startHeight + delta));
          if (consoleDockEl) {
            consoleDockEl.style.height = `${consoleDockHeight}px`;
          }
        }

        function onUp() {
          window.removeEventListener('pointermove', onMove);
          window.removeEventListener('pointerup', onUp);
        }

        window.addEventListener('pointermove', onMove);
        window.addEventListener('pointerup', onUp);
      }

      function destroyConsoleDock() {
        if (consoleDockEl) {
          consoleDockEl.remove();
          consoleDockEl = null;
        }
        consoleDockEnabled = false;
      }

      // WCAG Checker
      function checkWCAG() {
        if (!checkAccessibility) return;

        wcagIssues.length = 0;
        clearAccessibilityHighlights();

        // Check for missing alt text
        document.querySelectorAll('img:not([alt])').forEach(img => {
          wcagIssues.push({
            type: 'missing-alt',
            element: img.src ? `<img src="${img.src.substring(0, 50)}...">` : '<img>',
            elementRef: img,
            message: 'Image missing alt attribute',
            wcagLevel: '1.1.1 Level A'
          });
        });

        // Check for empty buttons
        document.querySelectorAll('button').forEach(button => {
          if (!button.textContent.trim() && !button.getAttribute('aria-label')) {
            wcagIssues.push({
              type: 'missing-label',
              element: '<button>',
              elementRef: button,
              message: 'Button has no accessible text',
              wcagLevel: '4.1.2 Level A'
            });
          }
        });

        // Check form inputs without labels
        document.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(input => {
          const id = input.id;
          const hasLabel = id && document.querySelector(`label[for="${id}"]`);
          const hasAriaLabel = input.getAttribute('aria-label');

          if (!hasLabel && !hasAriaLabel) {
            wcagIssues.push({
              type: 'missing-label',
              element: `<${input.tagName.toLowerCase()} type="${input.type || 'text'}">`,
              elementRef: input,
              message: 'Form control missing label',
              wcagLevel: '1.3.1 Level A'
            });
          }
        });

        // Check heading structure
        const headings = Array.from(document.querySelectorAll('h1, h2, h3, h4, h5, h6'));
        let lastLevel = 0;
        headings.forEach(heading => {
          const level = parseInt(heading.tagName[1]);
          if (level - lastLevel > 1) {
            wcagIssues.push({
              type: 'missing-heading',
              element: `<${heading.tagName.toLowerCase()}>`,
              elementRef: heading,
              message: `Heading level skipped (${lastLevel} to ${level})`,
              wcagLevel: '1.3.1 Level A'
            });
          }
          lastLevel = level;
        });

        // Check for links without text
        document.querySelectorAll('a[href]').forEach(link => {
          if (!link.textContent.trim() && !link.getAttribute('aria-label')) {
            wcagIssues.push({
              type: 'missing-label',
              element: `<a href="${link.href.substring(0, 30)}...">`,
              elementRef: link,
              message: 'Link has no accessible text',
              wcagLevel: '2.4.4 Level A'
            });
          }
        });

        if (highlightEnabled) {
          wcagIssues.forEach(issue => {
            if (issue.elementRef instanceof Element) {
              issue.elementRef.classList.add('wv-a11y-highlight');
              highlightedNodes.add(issue.elementRef);
            }
          });
        }

        updateDebugOverlay();
      }

      // ============================================================
      // Core Web Vitals Measurements
      // ============================================================

      // LCP - Largest Contentful Paint
      // Loading performance: time until largest visible element renders
      function measureLCP() {
        if (!PerformanceObserver || !PerformanceObserver.supportedEntryTypes?.includes('largest-contentful-paint')) {
          lcpUnsupported = true;
          return;
        }

        try {
          let lcpValue = 0;
          let lcpEntries = [];
          let observer;

          const reportLCP = () => {
            if (lcpValue > 0) {
              vitals.LCP = lcpValue; console.log("[WV] LCP:", vitals.LCP);
              recordMetric('LCP', vitals.LCP);
              updateDebugOverlay();
            }
          };

          const handleEntries = (entries) => {
            for (const entry of entries) {
              // Only report if the page wasn't hidden before this LCP
              if (entry.startTime < visibilityWatcher.firstHiddenTime) {
                // Subtract activationStart for prerendered pages
                const value = Math.max(entry.startTime - getActivationStart(), 0);
                if (value > 0) {
                  lcpValue = Math.round(value);
                  lcpEntries.push(entry);
                  // Live update in debug overlay (final report happens in stopListening)
                  vitals.LCP = lcpValue; console.log("[WV] LCP:", vitals.LCP);
                  updateDebugOverlay();
                }
              }
            }
          };

          // Stop observing on user interaction (LCP stops after first input)
          const stopListening = runOnce(() => {
            whenIdleOrHidden(() => {
              if (observer) {
                handleEntries(observer.takeRecords());
                observer.disconnect();
              }
              reportLCP();
            });
          });

          // Stop on keydown, click (pointerdown), or visibility change
          ['keydown', 'click'].forEach(type => {
            addEventListener(type, () => stopListening(), { capture: true, once: true });
          });

          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
              stopListening();
            }
          }, { capture: true });

          observer = new PerformanceObserver((list) => {
            handleEntries(list.getEntries());
          });

          observer.observe({ type: 'largest-contentful-paint', buffered: true });

          // Handle BFCache restoration
          onBFCacheRestore((event) => {
            lcpValue = 0;
            lcpEntries = [];
            doubleRAF(() => {
              lcpValue = Math.round(performance.now() - event.timeStamp);
              reportLCP();
            });
          });

        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] LCP error:', e);
        }
      }

      // FID - First Input Delay
      // Input responsiveness: delay between first interaction and browser response
      // Deprecated in favor of INP, but still tracked for compatibility
      function measureFID() { console.log("[WV] measureFID called");
        try {
          let observer;

          const handleEntries = (entries) => {
            const firstEntry = entries[0];
            if (firstEntry) {
              // Only report if the page wasn't hidden before this input
              if (firstEntry.startTime < visibilityWatcher.firstHiddenTime) {
                console.log("[WV] FID entry received:", firstEntry); const fidValue = Math.round(firstEntry.processingStart - firstEntry.startTime);
                vitals.FID = fidValue;
                recordMetric('FID', vitals.FID);
                updateDebugOverlay();
              }
              if (observer) observer.disconnect();
            }
          };

          observer = new PerformanceObserver((list) => {
            handleEntries(list.getEntries());
          });

          console.log("[WV] FID observer registered, supported types:", PerformanceObserver.supportedEntryTypes); observer.observe({ type: 'first-input', buffered: true });

          // Handle BFCache - reset FID on restore
          onBFCacheRestore(() => {
            delete vitals.FID;
            observer = new PerformanceObserver((list) => {
              handleEntries(list.getEntries());
            });
            console.log("[WV] FID observer registered, supported types:", PerformanceObserver.supportedEntryTypes); observer.observe({ type: 'first-input', buffered: true });
          });

        } catch (e) {
          console.error('[WV] FID error:', e);
        }
      }

      // CLS - Cumulative Layout Shift
      // Visual stability: measures unexpected layout movements
      // Uses session windows (max 5s, 1s gap)
      function measureCLS() {
        try {
          let clsValue = 0;
          let sessionValue = 0;
          let sessionEntries = [];
          let observer;

          const MAX_SESSION_DURATION = 5000; // 5 second max session window
          const SESSION_GAP = 1000; // 1 second gap resets session

          const reportCLS = () => {
            console.log("[WV] CLS:", Math.round(clsValue * 1000) / 1000); vitals.CLS = Math.round(clsValue * 1000) / 1000;
            recordMetric('CLS', vitals.CLS);
            updateDebugOverlay();
          };

          const handleEntries = (entries) => {
            for (const entry of entries) {
              // Only count shifts without recent user input
              if (!entry.hadRecentInput) {
                const firstEntry = sessionEntries[0];
                const lastEntry = sessionEntries[sessionEntries.length - 1];

                // Start new session if:
                // 1. Gap > 1 second since last entry, OR
                // 2. Session duration > 5 seconds
                if (sessionValue > 0 && (
                  entry.startTime - lastEntry.startTime > SESSION_GAP ||
                  entry.startTime - firstEntry.startTime > MAX_SESSION_DURATION
                )) {
                  sessionValue = 0;
                  sessionEntries = [];
                }

                sessionEntries.push(entry);
                sessionValue += entry.value;

                if (sessionValue > clsValue) {
                  clsValue = sessionValue;
                  reportCLS();
                }
              }
            }
          };

          observer = new PerformanceObserver((list) => {
            handleEntries(list.getEntries());
          });

          observer.observe({ type: 'layout-shift', buffered: true });

          // Initialize CLS to 0 immediately (no shifts = good)
          vitals.CLS = 0;
          updateDebugOverlay();

          // Report final CLS on page hide
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
              handleEntries(observer.takeRecords());
              reportCLS();
            }
          }, { capture: true });

          // Handle BFCache - reset CLS on restore
          onBFCacheRestore(() => {
            clsValue = 0;
            sessionValue = 0;
            sessionEntries = [];
            reportCLS();
          });

        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] CLS not supported:', e);
        }
      }

      // FCP - First Contentful Paint
      // Initial render: time until first content appears
      function measureFCP() {
        try {
          let observer;

          const reportFCP = (value) => {
            vitals.FCP = value; console.log("[WV] FCP:", vitals.FCP);
            recordMetric('FCP', vitals.FCP);
            updateDebugOverlay();
          };

          const handleEntries = (entries) => {
            const fcpEntry = entries.find(e => e.name === 'first-contentful-paint');
            if (fcpEntry) {
              // Only report if the page wasn't hidden before FCP
              if (fcpEntry.startTime < visibilityWatcher.firstHiddenTime) {
                // Subtract activationStart for prerendered pages
                const value = Math.max(fcpEntry.startTime - getActivationStart(), 0);
                reportFCP(Math.round(value));
              }
              if (observer) observer.disconnect();
            }
          };

          observer = new PerformanceObserver((list) => {
            handleEntries(list.getEntries());
          });

          observer.observe({ type: 'paint', buffered: true });

          // Handle BFCache restoration
          onBFCacheRestore((event) => {
            delete vitals.FCP;
            doubleRAF(() => {
              reportFCP(Math.round(performance.now() - event.timeStamp));
            });
          });

        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] FCP not supported:', e);
        }
      }

      // TTFB - Time to First Byte
      // Server response: time until first byte received
      function measureTTFB() {
        try {
          const reportTTFB = () => {
            const navEntry = performance.getEntriesByType('navigation')[0];
            if (navEntry) {
              // Subtract activationStart for prerendered pages
              const value = Math.max(navEntry.responseStart - getActivationStart(), 0);
              vitals.TTFB = Math.round(value); console.log("[WV] TTFB:", vitals.TTFB);
              recordMetric('TTFB', vitals.TTFB);
              updateDebugOverlay();
            }
          };

          // Wait until loadEventEnd is available for complete navigation data
          const whenReady = (callback) => {
            if (document.readyState === 'complete') {
              // Use setTimeout to ensure loadEventEnd is populated
              setTimeout(callback, 0);
            } else {
              addEventListener('load', () => setTimeout(callback, 0), { once: true });
            }
          };

          whenReady(reportTTFB);

          // Handle BFCache restoration
          onBFCacheRestore((event) => {
            delete vitals.TTFB;
            doubleRAF(() => {
              vitals.TTFB = Math.round(performance.now() - event.timeStamp);
              recordMetric('TTFB', vitals.TTFB);
              updateDebugOverlay();
            });
          });

        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] TTFB not supported:', e);
        }
      }

      // INP - Interaction to Next Paint
      // Responsiveness: 98th percentile of all interaction delays
      function measureINP() {
        try {
          // Store interaction durations for 98th percentile calculation
          const interactionMap = new Map(); // interactionId -> max duration
          let observer;

          // Calculate 98th percentile from interaction durations
          const getP98 = () => {
            const durations = Array.from(interactionMap.values()).sort((a, b) => b - a);
            if (durations.length === 0) return 0;

            // 98th percentile: we want the value that 98% of values are <= to
            // For small samples, use the highest value
            // Formula: index = ceil(N * 0.98) - 1, but for small N use max
            const len = durations.length;
            if (len <= 10) {
              // For <= 10 interactions, use the worst one
              return durations[0];
            } else if (len <= 50) {
              // For 11-50, use 2nd worst
              return durations[Math.min(1, len - 1)];
            } else {
              // For > 50, calculate proper 98th percentile
              const index = Math.max(0, Math.ceil(len * 0.02) - 1);
              return durations[index];
            }
          };

          const reportINP = () => {
            const p98 = getP98();
            if (p98 > 0) {
              vitals.INP = Math.round(p98);
              recordMetric('INP', vitals.INP);
              updateDebugOverlay();
            }
          };

          const handleEntries = (entries) => {
            // Process entries in idle time to avoid affecting INP itself
            whenIdleOrHidden(() => {
              for (const entry of entries) {
                // Only process entries with valid interactionId
                if (entry.interactionId) {
                  const existingDuration = interactionMap.get(entry.interactionId) || 0;
                  // Use duration (includes processing + presentation delay)
                  if (entry.duration > existingDuration) {
                    interactionMap.set(entry.interactionId, entry.duration);
                  }
                }
              }
              reportINP();
            });
          };

          observer = new PerformanceObserver((list) => {
            handleEntries(list.getEntries());
          });

          // durationThreshold: 40ms filters out very fast interactions
          // This is the minimum event duration (2.5+ frames at 60Hz)
          observer.observe({ type: 'event', buffered: true, durationThreshold: 40 });

          // Also observe first-input for fallback
          try {
            console.log("[WV] FID observer registered, supported types:", PerformanceObserver.supportedEntryTypes); observer.observe({ type: 'first-input', buffered: true });
          } catch (e) {
            // first-input might not be supported with event observer
          }

          // Report on visibility change
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
              handleEntries(observer.takeRecords());
              reportINP();
            }
          }, { capture: true });

          // Handle BFCache - reset INP on restore
          onBFCacheRestore(() => {
            interactionMap.clear();
            delete vitals.INP;
          });

        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] INP not supported:', e);
        }
      }

      // ============================================================
      // Additional Navigation Timing Metrics
      // ============================================================

      function measureDNS() {
        try {
          const navEntry = performance.getEntriesByType('navigation')[0];
          if (navEntry && navEntry.domainLookupEnd > navEntry.domainLookupStart) {
            vitals.DNS = Math.round(navEntry.domainLookupEnd - navEntry.domainLookupStart);
            recordMetric('DNS', vitals.DNS);
            updateDebugOverlay();
          }
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] DNS not available:', e);
        }
      }

      function measureTCP() {
        try {
          const navEntry = performance.getEntriesByType('navigation')[0];
          if (navEntry && navEntry.connectEnd > navEntry.connectStart) {
            vitals.TCP = Math.round(navEntry.connectEnd - navEntry.connectStart);
            recordMetric('TCP', vitals.TCP);
            updateDebugOverlay();
          }
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] TCP not available:', e);
        }
      }

      function measureDOM() {
        try {
          const navEntry = performance.getEntriesByType('navigation')[0];
          if (navEntry && navEntry.domInteractive > navEntry.responseEnd) {
            vitals.DOM = Math.round(navEntry.domInteractive - navEntry.responseEnd);
            recordMetric('DOM', vitals.DOM);
            updateDebugOverlay();
          }
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] DOM not available:', e);
        }
      }

      function measureLOAD() {
        try {
          const navEntry = performance.getEntriesByType('navigation')[0];
          if (navEntry && navEntry.loadEventEnd > 0) {
            vitals.LOAD = Math.round(navEntry.loadEventEnd - navEntry.startTime);
            recordMetric('LOAD', vitals.LOAD);
            updateDebugOverlay();
          }
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] LOAD not available:', e);
        }
      }

      // Batch reporting logic
      function recordMetric(name, value) {
        const metric = {
          name,
          value,
          timestamp: Date.now()
        };

        if (batchReporting) {
          metricsBuffer.push(metric);

          if (metricsBuffer.length >= 10 || !batchTimer) {
            if (batchTimer) clearTimeout(batchTimer);
            batchTimer = setTimeout(flushMetrics, batchInterval);
          }
        } else {
          sendMetrics(metric);
        }
      }

      function flushMetrics() {
        if (metricsBuffer.length === 0) return;
        sendMetrics([...metricsBuffer]);
        metricsBuffer.length = 0;
        if (batchTimer) {
          clearTimeout(batchTimer);
          batchTimer = null;
        }
      }

      function sendMetrics(metrics) {
        if (!endpoint) return;

        const payload = {
          metrics: Array.isArray(metrics) ? metrics : [metrics],
          sessionId: sessionId,
          userId: userId,
          timestamp: Date.now(),
          url: window.location.href,
          userAgent: navigator.userAgent
        };

        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...headers
          },
          body: JSON.stringify(payload),
          keepalive: true
        }).catch(err => {
          if (debug) console.warn('[@casoon/astro-webvitals] Failed to send metrics:', err);
        });
      }

      // Navigation timing metrics (available immediately)
      measureDNS();
      measureTCP();
      console.log("[WV] Starting measurements..."); measureTTFB();
      measureDOM();

      // Paint metrics
      console.log("[WV] Before measureFCP"); measureFCP(); console.log("[WV] After measureFCP");
      console.log("[WV] Before measureLCP"); measureLCP(); console.log("[WV] After measureLCP");

      // Interaction metrics
      console.log("[WV] Before measureFID"); measureFID(); console.log("[WV] After measureFID");
      measureINP();
      measureCLS();

      // Load complete (might take a while)
      if (document.readyState === 'complete') {
        measureLOAD();
      } else {
        window.addEventListener('load', () => {
          measureLOAD();
        });
      }

      // Check accessibility after DOM is ready
      if (checkAccessibility) {
        if (document.readyState === 'complete') {
          setTimeout(() => preserveContentScroll(checkWCAG), 1000);
        } else {
          window.addEventListener('load', () => setTimeout(() => preserveContentScroll(checkWCAG), 1000));
        }
      }

       // SEO analysis
      const runSEO = () => refreshSEO();
      if (document.readyState === 'complete') {
        setTimeout(runSEO, 600);
      } else {
        window.addEventListener('load', () => setTimeout(runSEO, 600));
      }

      // Flush on page unload
      window.addEventListener('beforeunload', flushMetrics);

      // Periodic refresh without breaking scroll: only update lightweight data
      setInterval(() => {
        if (checkAccessibility && isExpanded && activeTab === 'accessibility') {
          preserveContentScroll(checkWCAG);
        }
        if (activeTab === 'seo') {
          refreshSEO();
        }
      }, 5000);
    })();
  </script>
)}
