---
/**
 * @casoon/astro-webvitals
 *
 * Comprehensive Web Vitals & Accessibility monitoring for Astro
 * Measures Core Web Vitals, detects WCAG issues, and provides actionable insights
 *
 * @see https://github.com/casoon/astro-webvitals
 */

export interface Props {
  /**
   * Enable debug overlay (shows metrics and accessibility issues)
   * @default false
   */
  debug?: boolean;

  /**
   * Optional endpoint to send metrics to
   * Metrics will be sent as POST requests with JSON payload
   */
  endpoint?: string;

  /**
   * Position of debug overlay
   * @default 'bottom-right'
   */
  position?: 'top-right' | 'top-left' | 'bottom-right' | 'bottom-left';

  /**
   * Track metrics even in development mode
   * @default false
   */
  trackInDev?: boolean;

  /**
   * Sampling rate (0-1) - only track percentage of users
   * @default 1 (100% of users)
   */
  sampleRate?: number;

  /**
   * Batch metrics before sending (reduces requests)
   * @default true
   */
  batchReporting?: boolean;

  /**
   * Batch interval in milliseconds
   * @default 5000 (5 seconds)
   */
  batchInterval?: number;

  /**
   * Enable WCAG accessibility checking
   * @default true when debug is enabled
   */
  checkAccessibility?: boolean;

  /**
   * Enable extended metrics (Long Tasks, Memory, Network)
   * @default false
   */
  extendedMetrics?: boolean;

  /**
   * Enable smart detection (rage clicks, dead clicks)
   * @default false
   */
  smartDetection?: boolean;

  /**
   * Performance budget thresholds
   */
  performanceBudget?: {
    LCP?: number;
    FID?: number;
    CLS?: number;
    FCP?: number;
    TTFB?: number;
    INP?: number;
  };

  /**
   * Custom headers for endpoint requests
   */
  headers?: Record<string, string>;

  /**
   * Session ID for tracking
   */
  sessionId?: string;

  /**
   * User ID for tracking
   */
  userId?: string;
}

const {
  debug = false,
  endpoint,
  position = 'bottom-right',
  trackInDev = false,
  sampleRate = 1,
  batchReporting = true,
  batchInterval = 5000,
  checkAccessibility = debug,
  extendedMetrics = false,
  smartDetection = false,
  performanceBudget,
  headers = {},
  sessionId,
  userId
} = Astro.props;

const isDev = import.meta.env.DEV;
const shouldTrack = (!isDev || trackInDev || debug) && Math.random() < sampleRate;

// Detect if mobile
const isMobile = typeof window !== 'undefined' && window.innerWidth <= 768;

// Position styles will be determined dynamically based on viewport
const desktopPositions = {
  'top-right': 'top: 16px; right: 16px;',
  'top-left': 'top: 16px; left: 16px;',
  'bottom-right': 'bottom: 16px; right: 16px;',
  'bottom-left': 'bottom: 16px; left: 16px;'
};

const mobilePosition = 'bottom: 0; left: 0; right: 0;'; // Full width at bottom for mobile

const defaultBudgets = {
  LCP: 2500,
  FID: 100,
  CLS: 0.1,
  FCP: 1800,
  TTFB: 800,
  INP: 200,
  ...performanceBudget
};
---

{shouldTrack && (
  <script is:inline define:vars={{
    debug,
    endpoint,
    position,
    desktopPositions,
    mobilePosition,
    batchReporting,
    batchInterval,
    checkAccessibility,
    extendedMetrics,
    smartDetection,
    performanceBudget: defaultBudgets,
    headers,
    sessionId: sessionId || `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
    userId,
    sampleRate
  }}>
    // @casoon/astro-webvitals - Unified Component
    (function() {
      const vitals = {};
      const metricsBuffer = [];
      const wcagIssues = [];
      let debugContainer;
      let batchTimer;
      let isExpanded = false;
      let activeTab = 'vitals'; // vitals, accessibility, details, console

      // Check if mobile (responsive under 700px)
      let isMobile = window.innerWidth < 700;
      let consoleErrors = [];
      let consoleMode = false; // Toggle for console mode

      // Track which accessibility issues are expanded
      let expandedIssues = new Set();

      // Listen for viewport changes
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          const newIsMobile = window.innerWidth < 700;
          if (newIsMobile !== isMobile) {
            isMobile = newIsMobile;
            if (debugContainer) {
              updateDebugOverlay();
            }
          }
        }, 250); // Debounce resize events
      });

      // Console error detection
      const originalError = console.error;
      console.error = function(...args) {
        originalError.apply(console, args);
        const error = {
          type: 'error',
          message: args.map(arg =>
            typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
          ).join(' '),
          timestamp: new Date().toISOString(),
          stack: new Error().stack
        };
        consoleErrors.push(error);
        if (consoleErrors.length > 100) {
          consoleErrors.shift(); // Keep max 100 errors
        }
        if (debugContainer && activeTab === 'console') {
          updateDebugOverlay();
        }
      };

      // Custom console logging
      window.webVitalsLog = {
        info: function(...args) {
          if (consoleMode) {
            consoleErrors.push({
              type: 'info',
              message: args.join(' '),
              timestamp: new Date().toISOString()
            });
            if (consoleErrors.length > 100) consoleErrors.shift();
            if (debugContainer && activeTab === 'console') updateDebugOverlay();
          }
        },
        warn: function(...args) {
          if (consoleMode) {
            consoleErrors.push({
              type: 'warn',
              message: args.join(' '),
              timestamp: new Date().toISOString()
            });
            if (consoleErrors.length > 100) consoleErrors.shift();
            if (debugContainer && activeTab === 'console') updateDebugOverlay();
          }
        },
        error: function(...args) {
          if (consoleMode) {
            consoleErrors.push({
              type: 'error',
              message: args.join(' '),
              timestamp: new Date().toISOString()
            });
            if (consoleErrors.length > 100) consoleErrors.shift();
            if (debugContainer && activeTab === 'console') updateDebugOverlay();
          }
        }
      };

      // Initialize debug overlay
      if (debug) {
        createDebugOverlay();
      }

      function createDebugOverlay() {
        debugContainer = document.createElement('div');
        debugContainer.id = 'astro-webvitals-debug';
        debugContainer.setAttribute('role', 'status');
        debugContainer.setAttribute('aria-label', 'Web Vitals & Accessibility Monitor');
        debugContainer.setAttribute('aria-live', 'polite');

        // Add global styles for animations
        if (!document.getElementById('wv-styles')) {
          const styleSheet = document.createElement('style');
          styleSheet.id = 'wv-styles';
          styleSheet.textContent = `
            @keyframes wv-pulse {
              0%, 100% { opacity: 1; }
              50% { opacity: 0.5; }
            }
            .wv-pulse {
              animation: wv-pulse 1.5s ease-in-out infinite;
            }
            @keyframes wv-spin {
              from { transform: rotate(0deg); }
              to { transform: rotate(360deg); }
            }
            .wv-spin {
              animation: wv-spin 1s linear infinite;
            }
            #astro-webvitals-debug * {
              box-sizing: border-box;
            }
            #astro-webvitals-debug::-webkit-scrollbar {
              width: 4px;
              height: 4px;
            }
            #astro-webvitals-debug::-webkit-scrollbar-track {
              background: rgba(255, 255, 255, 0.05);
              border-radius: 2px;
            }
            #astro-webvitals-debug::-webkit-scrollbar-thumb {
              background: rgba(96, 165, 250, 0.5);
              border-radius: 2px;
            }
            #astro-webvitals-debug::-webkit-scrollbar-thumb:hover {
              background: rgba(96, 165, 250, 0.8);
            }
          `;
          document.head.appendChild(styleSheet);
        }

        // Minimized view by default
        updateDebugOverlay();
        document.body.appendChild(debugContainer);
      }

      function updateDebugOverlay() {
        if (!debugContainer) return;

        const metricsCount = Object.keys(vitals).length;
        const issuesCount = wcagIssues.length;

        // Calculate overall score
        let score = 100;
        if (vitals.LCP > performanceBudget.LCP) score -= 20;
        if (vitals.FID > performanceBudget.FID) score -= 20;
        if (vitals.CLS > performanceBudget.CLS) score -= 20;
        if (vitals.FCP > performanceBudget.FCP) score -= 10;
        if (vitals.TTFB > performanceBudget.TTFB) score -= 10;
        if (issuesCount > 0) score -= Math.min(20, issuesCount * 5);
        score = Math.max(0, score);

        const scoreColor = score >= 80 ? '#10B981' : score >= 60 ? '#F59E0B' : '#EF4444';
        const scoreEmoji = score >= 80 ? '‚úÖ' : score >= 60 ? '‚ö†Ô∏è' : '‚ùå';

        // Mobile-specific styles
        const currentPositionStyle = isMobile ? mobilePosition : desktopPositions[position];
        const containerStyles = isMobile ? `
          position: fixed;
          ${mobilePosition}
          background: rgba(17, 24, 39, 0.98);
          color: white;
          border-radius: ${isExpanded ? '16px 16px 0 0' : '0'};
          font-family: 'SF Mono', Monaco, 'Courier New', monospace;
          font-size: 12px;
          z-index: 10000;
          box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.4);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          border-bottom: none;
          transition: all 0.3s ease;
          max-width: 100%;
          transform: translateY(${isExpanded ? '0' : 'calc(100% - 48px)'});
          overflow: hidden;
        ` : `
          position: fixed;
          ${desktopPositions[position]}
          background: rgba(17, 24, 39, 0.95);
          color: white;
          border-radius: 12px;
          font-family: 'SF Mono', Monaco, 'Courier New', monospace;
          font-size: 12px;
          z-index: 10000;
          box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
          backdrop-filter: blur(10px);
          border: 1px solid rgba(255, 255, 255, 0.1);
          transition: all 0.3s ease;
          max-width: ${isExpanded ? '420px' : '280px'};
          overflow: hidden;
        `;

        debugContainer.innerHTML = `
          <div style="${containerStyles}">
            <!-- Header -->
            <div style="
              padding: 12px 16px;
              border-bottom: 1px solid rgba(255, 255, 255, 0.1);
              cursor: pointer;
              user-select: none;
            " onclick="window.toggleWebVitalsDebug()">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 8px;">
                  <span style="font-size: 14px;">${scoreEmoji}</span>
                  <span style="font-weight: 600; color: #E5E7EB;">Performance</span>
                  <span style="
                    background: ${scoreColor};
                    color: white;
                    padding: 2px 6px;
                    border-radius: 4px;
                    font-size: 10px;
                    font-weight: bold;
                  ">${score}</span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  ${sampleRate < 1 ? `<span style="font-size: 10px; color: #9CA3AF;">üìä ${(sampleRate * 100).toFixed(0)}%</span>` : ''}
                  <button
                    onclick="event.stopPropagation(); document.getElementById('astro-webvitals-debug').remove();"
                    style="
                      background: transparent;
                      border: none;
                      color: #6B7280;
                      cursor: pointer;
                      padding: 0;
                      width: 16px;
                      height: 16px;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      border-radius: 4px;
                      transition: all 0.2s;
                      font-size: 16px;
                      line-height: 1;
                      font-weight: bold;
                    "
                    onmouseover="this.style.color='#EF4444'; this.style.background='rgba(239, 68, 68, 0.1)';"
                    onmouseout="this.style.color='#6B7280'; this.style.background='transparent';"
                    aria-label="Close performance monitor"
                    title="Close (reopens on page reload)"
                  >√ó</button>
                  <span style="
                    transform: rotate(${isExpanded ? '180deg' : '0'});
                    transition: transform 0.3s;
                    font-size: 10px;
                  ">‚ñº</span>
                </div>
              </div>

              ${!isExpanded ? `
                <!-- Minimized Summary -->
                <div style="display: flex; gap: 12px; margin-top: 8px; font-size: 11px; color: #9CA3AF;">
                  ${metricsCount > 0 ? `<span>üìä ${metricsCount} metrics</span>` : '<span>üìä Measuring...</span>'}
                  ${issuesCount > 0 ? `<span style="color: #F59E0B;">‚ö†Ô∏è ${issuesCount} issues</span>` : ''}
                </div>
              ` : ''}
            </div>

            ${isExpanded ? `
              <!-- Tabs -->
              <div style="
                display: flex;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                padding: 0 16px;
              ">
                <button onclick="window.setWebVitalsTab('vitals')" style="
                  background: none;
                  border: none;
                  color: ${activeTab === 'vitals' ? '#60A5FA' : '#9CA3AF'};
                  padding: 8px 12px;
                  cursor: pointer;
                  font-size: 11px;
                  font-weight: 500;
                  border-bottom: 2px solid ${activeTab === 'vitals' ? '#60A5FA' : 'transparent'};
                  transition: all 0.2s;
                ">Core Vitals</button>

                ${checkAccessibility ? `
                  <button onclick="window.setWebVitalsTab('accessibility')" style="
                    background: none;
                    border: none;
                    color: ${activeTab === 'accessibility' ? '#60A5FA' : '#9CA3AF'};
                    padding: 8px 12px;
                    cursor: pointer;
                    font-size: 11px;
                    font-weight: 500;
                    border-bottom: 2px solid ${activeTab === 'accessibility' ? '#60A5FA' : 'transparent'};
                    transition: all 0.2s;
                    position: relative;
                  ">
                    Accessibility
                    ${issuesCount > 0 ? `<span style="
                      position: absolute;
                      top: 4px;
                      right: 4px;
                      background: #EF4444;
                      color: white;
                      border-radius: 10px;
                      padding: 1px 5px;
                      font-size: 9px;
                    ">${issuesCount}</span>` : ''}
                  </button>
                ` : ''}

                ${extendedMetrics || smartDetection ? `
                  <button onclick="window.setWebVitalsTab('details')" style="
                    background: none;
                    border: none;
                    color: ${activeTab === 'details' ? '#60A5FA' : '#9CA3AF'};
                    padding: 8px 12px;
                    cursor: pointer;
                    font-size: 11px;
                    font-weight: 500;
                    border-bottom: 2px solid ${activeTab === 'details' ? '#60A5FA' : 'transparent'};
                    transition: all 0.2s;
                  ">Details</button>
                ` : ''}

                <button onclick="window.setWebVitalsTab('console')" style="
                  background: none;
                  border: none;
                  color: ${activeTab === 'console' ? '#60A5FA' : '#9CA3AF'};
                  padding: 8px 12px;
                  cursor: pointer;
                  font-size: 11px;
                  font-weight: 500;
                  border-bottom: 2px solid ${activeTab === 'console' ? '#60A5FA' : 'transparent'};
                  transition: all 0.2s;
                  position: relative;
                ">
                  Console
                  ${consoleErrors.filter(e => e.type === 'error').length > 0 ? `<span style="
                    position: absolute;
                    top: 4px;
                    right: 4px;
                    background: #EF4444;
                    color: white;
                    border-radius: 10px;
                    padding: 1px 5px;
                    font-size: 9px;
                  ">${consoleErrors.filter(e => e.type === 'error').length}</span>` : ''}
                </button>
              </div>

              <!-- Content -->
              <div style="padding: 12px 16px; max-height: ${isMobile ? '60vh' : '400px'}; overflow-y: auto;">
                ${activeTab === 'vitals' ? getVitalsContent() : ''}
                ${activeTab === 'accessibility' ? getAccessibilityContent() : ''}
                ${activeTab === 'details' ? getDetailsContent() : ''}
                ${activeTab === 'console' ? getConsoleContent() : ''}
              </div>

              <!-- Footer -->
              <div style="
                padding: 8px 16px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
                display: flex;
                justify-content: space-between;
                align-items: center;
              ">
                <a href="https://github.com/casoon/astro-webvitals"
                   target="_blank"
                   rel="noopener noreferrer"
                   style="color: #60A5FA; text-decoration: none; font-size: 10px;">
                  @casoon/astro-webvitals
                </a>
                <button
                  onclick="document.getElementById('astro-webvitals-debug').remove()"
                  aria-label="Close monitor"
                  style="
                    background: none;
                    border: 1px solid #4B5563;
                    color: #9CA3AF;
                    cursor: pointer;
                    padding: 2px 8px;
                    border-radius: 4px;
                    font-size: 10px;
                  ">Close</button>
              </div>
            ` : ''}
          </div>
        `;
      }

      // Helper to get metric rating info
      function getMetricRating(key, value) {
        const thresholds = {
          LCP: { good: 2500, poor: 4000 },
          FID: { good: 100, poor: 300 },
          CLS: { good: 0.1, poor: 0.25 },
          FCP: { good: 1800, poor: 3000 },
          TTFB: { good: 800, poor: 1800 },
          INP: { good: 200, poor: 500 }
        };

        const t = thresholds[key];
        if (!t) return { status: '‚è≥', color: '#9CA3AF', rating: 'measuring', percent: 0 };

        if (value <= t.good) {
          return { status: '‚úÖ', color: '#10B981', rating: 'good', percent: Math.min(100, (value / t.good) * 100) };
        } else if (value <= t.poor) {
          return { status: '‚ö†Ô∏è', color: '#F59E0B', rating: 'needs improvement', percent: 50 + ((value - t.good) / (t.poor - t.good)) * 50 };
        } else {
          return { status: '‚ùå', color: '#EF4444', rating: 'poor', percent: 100 };
        }
      }

      // Render radial gauge SVG
      function renderRadialGauge(score, size = 80) {
        const radius = (size - 8) / 2;
        const circumference = 2 * Math.PI * radius;
        const offset = circumference - (score / 100) * circumference;
        const color = score >= 80 ? '#10B981' : score >= 60 ? '#F59E0B' : '#EF4444';

        return `
          <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" style="transform: rotate(-90deg);">
            <circle
              cx="${size/2}" cy="${size/2}" r="${radius}"
              fill="none"
              stroke="rgba(255,255,255,0.1)"
              stroke-width="6"
            />
            <circle
              cx="${size/2}" cy="${size/2}" r="${radius}"
              fill="none"
              stroke="url(#gaugeGradient)"
              stroke-width="6"
              stroke-linecap="round"
              stroke-dasharray="${circumference}"
              stroke-dashoffset="${offset}"
              style="transition: stroke-dashoffset 0.5s ease;"
            />
            <defs>
              <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stop-color="${color}" />
                <stop offset="100%" stop-color="${color}88" />
              </linearGradient>
            </defs>
          </svg>
          <div style="
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(0deg);
            font-size: 18px;
            font-weight: bold;
            color: ${color};
          ">${score}</div>
        `;
      }

      function getVitalsContent() {
        // Core Web Vitals (the 3 main ones)
        const coreMetrics = ['LCP', 'FID', 'CLS'];
        // Additional metrics
        const additionalMetrics = ['FCP', 'TTFB', 'INP'];
        // Navigation timing metrics
        const navMetrics = ['DNS', 'TCP', 'DOM', 'LOAD'];

        // Calculate overall score for radial gauge
        let score = 100;
        let measuredCount = 0;

        ['LCP', 'FID', 'CLS', 'FCP', 'TTFB', 'INP'].forEach(key => {
          if (typeof vitals[key] === 'number') {
            measuredCount++;
            const rating = getMetricRating(key, vitals[key]);
            if (rating.rating === 'poor') score -= 15;
            else if (rating.rating === 'needs improvement') score -= 8;
          }
        });
        score = Math.max(0, Math.min(100, score));

        let html = '';

        // Radial gauge header
        html += `
          <div style="
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(31, 41, 55, 0.5);
            border-radius: 12px;
          ">
            <div style="position: relative; width: 80px; height: 80px;">
              ${renderRadialGauge(score)}
            </div>
            <div style="margin-left: 16px;">
              <div style="font-size: 12px; color: #9CA3AF; margin-bottom: 4px;">Performance Score</div>
              <div style="font-size: 11px; color: #6B7280;">${measuredCount}/6 metrics measured</div>
              ${measuredCount < 6 ? '<div style="font-size: 10px; color: #60A5FA; margin-top: 4px;">Interact with the page for more metrics</div>' : ''}
            </div>
          </div>
        `;

        // Core Web Vitals section
        html += `<div style="font-size: 11px; color: #60A5FA; font-weight: 600; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
          <span>üìä</span> Core Web Vitals
        </div>`;

        html += coreMetrics.map(key => renderMetricRow(key)).join('');

        // Additional metrics section
        html += `<div style="font-size: 11px; color: #60A5FA; font-weight: 600; margin: 12px 0 8px 0; display: flex; align-items: center; gap: 6px;">
          <span>üìà</span> Additional Metrics
        </div>`;

        html += additionalMetrics.map(key => renderMetricRow(key)).join('');

        // Navigation timing section (if any are available)
        const hasNavMetrics = navMetrics.some(key => typeof vitals[key] === 'number');
        if (hasNavMetrics) {
          html += `<div style="font-size: 11px; color: #60A5FA; font-weight: 600; margin: 12px 0 8px 0; display: flex; align-items: center; gap: 6px;">
            <span>üåê</span> Navigation Timing
          </div>`;

          html += `<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 6px;">`;
          html += navMetrics.map(key => {
            const value = vitals[key];
            if (typeof value !== 'number') return '';
            return `
              <div style="
                padding: 8px;
                background: rgba(31, 41, 55, 0.3);
                border-radius: 6px;
                text-align: center;
              ">
                <div style="font-size: 10px; color: #9CA3AF;">${key}</div>
                <div style="font-size: 14px; color: #E5E7EB; font-weight: 600;">${value}ms</div>
              </div>
            `;
          }).join('');
          html += `</div>`;
        }

        return html;
      }

      function renderMetricRow(key) {
        const value = vitals[key];
        const hasValue = typeof value === 'number';
        const budget = performanceBudget[key];

        // Metric descriptions for better UX
        const metricDescriptions = {
          'LCP': { name: 'Largest Contentful Paint', hint: 'Loading performance' },
          'FID': { name: 'First Input Delay', hint: 'Input responsiveness' },
          'CLS': { name: 'Cumulative Layout Shift', hint: 'Visual stability' },
          'FCP': { name: 'First Contentful Paint', hint: 'Initial render' },
          'TTFB': { name: 'Time to First Byte', hint: 'Server response' },
          'INP': { name: 'Interaction to Next Paint', hint: 'Overall responsiveness' }
        };

        const metricInfo = metricDescriptions[key] || { name: key, hint: '' };

        // Show placeholder for metrics not yet measured
        if (!hasValue) {
          const waitingInfo = {
            'FID': { icon: 'üëÜ', text: 'Click or tap to measure', action: true },
            'INP': { icon: 'üëÜ', text: 'Interact to measure', action: true },
            'CLS': { icon: 'üìê', text: '0.000', isGood: true },
            'LCP': { icon: '‚è≥', text: 'Measuring...', loading: true },
            'FCP': { icon: '‚è≥', text: 'Measuring...', loading: true },
            'TTFB': { icon: '‚è≥', text: 'Measuring...', loading: true }
          };

          const info = waitingInfo[key] || { icon: '‚è≥', text: 'Pending...' };

          // For CLS, show 0 as default (no shifts = good)
          if (key === 'CLS') {
            return `
              <div style="
                padding: 10px;
                margin-bottom: 6px;
                background: rgba(31, 41, 55, 0.4);
                border-radius: 8px;
                border: 1px solid rgba(16, 185, 129, 0.2);
              ">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <span>‚úÖ</span>
                      <span style="font-weight: 600; color: #E5E7EB;">${key}</span>
                    </div>
                    <div style="font-size: 9px; color: #6B7280; margin-top: 2px;">${metricInfo.hint}</div>
                  </div>
                  <div style="text-align: right;">
                    <span style="color: #10B981; font-weight: 600;">0.000</span>
                    <div style="font-size: 9px; color: #10B981;">good</div>
                  </div>
                </div>
                <div style="margin-top: 6px; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden;">
                  <div style="height: 100%; width: 5%; background: #10B981;"></div>
                </div>
              </div>
            `;
          }

          // For interaction-based metrics (FID, INP), show call-to-action
          if (info.action) {
            return `
              <div style="
                padding: 10px;
                margin-bottom: 6px;
                background: rgba(31, 41, 55, 0.3);
                border-radius: 8px;
                border: 1px dashed rgba(96, 165, 250, 0.3);
              ">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                      <span>${info.icon}</span>
                      <span style="font-weight: 500; color: #9CA3AF;">${key}</span>
                    </div>
                    <div style="font-size: 9px; color: #6B7280; margin-top: 2px;">${metricInfo.hint}</div>
                  </div>
                  <div style="
                    background: rgba(96, 165, 250, 0.1);
                    color: #60A5FA;
                    padding: 4px 8px;
                    border-radius: 4px;
                    font-size: 10px;
                  ">${info.text}</div>
                </div>
              </div>
            `;
          }

          // Loading state for other metrics
          return `
            <div style="
              padding: 10px;
              margin-bottom: 6px;
              background: rgba(31, 41, 55, 0.3);
              border-radius: 8px;
              border: 1px solid rgba(255, 255, 255, 0.05);
              opacity: 0.7;
            ">
              <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                  <div style="display: flex; align-items: center; gap: 6px;">
                    <span class="wv-pulse">${info.icon}</span>
                    <span style="font-weight: 500; color: #9CA3AF;">${key}</span>
                  </div>
                  <div style="font-size: 9px; color: #6B7280; margin-top: 2px;">${metricInfo.hint}</div>
                </div>
                <span style="color: #6B7280; font-size: 11px;">${info.text}</span>
              </div>
            </div>
          `;
        }

        // Metric has a value - render with rating
        const formatted = key === 'CLS' ? value.toFixed(3) : `${value}ms`;
        const rating = getMetricRating(key, value);
        const exceededBudget = budget && value > budget;

        return `
          <div style="
            padding: 10px;
            margin-bottom: 6px;
            background: rgba(31, 41, 55, 0.5);
            border-radius: 8px;
            border: 1px solid ${exceededBudget ? 'rgba(239, 68, 68, 0.3)' : 'rgba(255, 255, 255, 0.05)'};
          ">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <div style="display: flex; align-items: center; gap: 6px;">
                  <span>${rating.status}</span>
                  <span style="font-weight: 600; color: #E5E7EB;">${key}</span>
                  ${exceededBudget ? '<span style="color: #EF4444; font-size: 9px; margin-left: 4px;">over budget</span>' : ''}
                </div>
                <div style="font-size: 9px; color: #6B7280; margin-top: 2px;">${metricInfo.hint}</div>
              </div>
              <div style="text-align: right;">
                <span style="color: ${rating.color}; font-weight: 600;">${formatted}</span>
                <div style="font-size: 9px; color: ${rating.color};">${rating.rating}</div>
              </div>
            </div>
            <div style="margin-top: 6px; height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden;">
              <div style="
                height: 100%;
                width: ${Math.min(100, rating.percent)}%;
                background: linear-gradient(90deg, ${rating.color}, ${rating.color}88);
                transition: width 0.3s ease;
              "></div>
            </div>
          </div>
        `;
      }

      function getAccessibilityContent() {
        if (wcagIssues.length === 0) {
          return `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 32px; margin-bottom: 8px;">‚úÖ</div>
              <div style="color: #10B981; font-weight: 500;">No accessibility issues detected</div>
              <div style="color: #6B7280; font-size: 11px; margin-top: 4px;">WCAG 2.1 Level AA compliant</div>
            </div>
          `;
        }

        // Group issues by type with full details
        const groupedIssues = wcagIssues.reduce((acc, issue, index) => {
          if (!acc[issue.type]) {
            acc[issue.type] = [];
          }
          acc[issue.type].push({ ...issue, id: index });
          return acc;
        }, {});

        const issueInfo = {
          'missing-alt': {
            icon: 'üñºÔ∏è',
            label: 'Missing Alt Text',
            description: 'Images should have descriptive alt text for screen readers.',
            link: 'https://web.dev/image-alt/'
          },
          'low-contrast': {
            icon: 'üé®',
            label: 'Low Contrast',
            description: 'Text should have sufficient contrast ratio for readability.',
            link: 'https://web.dev/color-contrast/'
          },
          'missing-label': {
            icon: 'üè∑Ô∏è',
            label: 'Missing Labels',
            description: 'Form elements and interactive controls need accessible labels.',
            link: 'https://web.dev/label/'
          },
          'missing-heading': {
            icon: 'üìù',
            label: 'Heading Issues',
            description: 'Heading levels should follow a logical hierarchy without skipping levels.',
            link: 'https://web.dev/heading-order/'
          },
          'keyboard': {
            icon: '‚å®Ô∏è',
            label: 'Keyboard Navigation',
            description: 'All interactive elements must be accessible via keyboard.',
            link: 'https://web.dev/keyboard-access/'
          }
        };

        return `
          <div style="padding: 4px;">
            <!-- Summary header -->
            <div style="
              margin-bottom: 12px;
              padding: 10px;
              background: rgba(245, 158, 11, 0.1);
              border-radius: 8px;
              border: 1px solid rgba(245, 158, 11, 0.3);
              display: flex;
              align-items: center;
              justify-content: space-between;
            ">
              <div>
                <div style="font-size: 12px; font-weight: 600; color: #F59E0B;">
                  ‚ö†Ô∏è ${wcagIssues.length} Issue${wcagIssues.length !== 1 ? 's' : ''} Found
                </div>
                <div style="font-size: 10px; color: #9CA3AF; margin-top: 2px;">
                  Click to expand details
                </div>
              </div>
              <div style="
                background: rgba(245, 158, 11, 0.2);
                color: #F59E0B;
                padding: 4px 10px;
                border-radius: 12px;
                font-size: 12px;
                font-weight: 600;
              ">${Object.keys(groupedIssues).length} categories</div>
            </div>

            <!-- Issue categories -->
            ${Object.entries(groupedIssues).map(([type, issues]) => {
              const info = issueInfo[type] || { icon: '‚ùì', label: type, description: '', link: '' };
              const isExpanded = expandedIssues.has(type);

              return `
                <div style="margin-bottom: 8px;">
                  <!-- Category header (clickable) -->
                  <div
                    onclick="window.toggleAccessibilityIssue('${type}')"
                    style="
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      padding: 10px 12px;
                      background: ${isExpanded ? 'rgba(245, 158, 11, 0.15)' : 'rgba(31, 41, 55, 0.5)'};
                      border-radius: ${isExpanded ? '8px 8px 0 0' : '8px'};
                      border-left: 3px solid ${issues.length > 3 ? '#EF4444' : '#F59E0B'};
                      cursor: pointer;
                      transition: all 0.2s;
                    "
                  >
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span>${info.icon}</span>
                      <span style="color: #E5E7EB; font-size: 12px; font-weight: 500;">${info.label}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px;">
                      <span style="
                        background: ${issues.length > 3 ? 'rgba(239, 68, 68, 0.2)' : 'rgba(245, 158, 11, 0.2)'};
                        color: ${issues.length > 3 ? '#EF4444' : '#F59E0B'};
                        padding: 2px 8px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 600;
                      ">${issues.length}</span>
                      <span style="
                        transform: rotate(${isExpanded ? '180deg' : '0deg'});
                        transition: transform 0.2s;
                        font-size: 10px;
                        color: #9CA3AF;
                      ">‚ñº</span>
                    </div>
                  </div>

                  <!-- Expanded details -->
                  ${isExpanded ? `
                    <div style="
                      background: rgba(31, 41, 55, 0.3);
                      border-radius: 0 0 8px 8px;
                      border: 1px solid rgba(255, 255, 255, 0.05);
                      border-top: none;
                      padding: 10px;
                    ">
                      <!-- Description -->
                      <div style="
                        font-size: 11px;
                        color: #9CA3AF;
                        margin-bottom: 10px;
                        padding-bottom: 10px;
                        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
                      ">
                        ${info.description}
                        ${info.link ? `<a href="${info.link}" target="_blank" rel="noopener noreferrer" style="color: #60A5FA; margin-left: 4px;">Learn more ‚Üí</a>` : ''}
                      </div>

                      <!-- Individual issues -->
                      ${issues.slice(0, 10).map((issue, i) => `
                        <div style="
                          font-size: 10px;
                          color: #E5E7EB;
                          padding: 6px 8px;
                          margin-bottom: 4px;
                          background: rgba(31, 41, 55, 0.5);
                          border-radius: 4px;
                          font-family: 'SF Mono', Monaco, monospace;
                          word-break: break-all;
                        ">
                          <span style="color: #6B7280;">${i + 1}.</span>
                          <span style="color: #F59E0B;">${issue.element || 'Element'}</span>
                          ${issue.message ? `<div style="color: #9CA3AF; margin-top: 2px; font-size: 9px;">${issue.message}</div>` : ''}
                        </div>
                      `).join('')}

                      ${issues.length > 10 ? `
                        <div style="font-size: 10px; color: #6B7280; text-align: center; padding: 4px;">
                          ... and ${issues.length - 10} more
                        </div>
                      ` : ''}
                    </div>
                  ` : ''}
                </div>
              `;
            }).join('')}

            <!-- Tips -->
            <div style="
              margin-top: 12px;
              padding: 10px;
              background: rgba(96, 165, 250, 0.1);
              border-radius: 8px;
              border: 1px solid rgba(96, 165, 250, 0.2);
            ">
              <div style="font-size: 10px; color: #60A5FA; font-weight: 500; margin-bottom: 4px;">üí° Quick Wins</div>
              <div style="font-size: 10px; color: #9CA3AF;">
                ${wcagIssues.some(i => i.type === 'missing-alt') ? '‚Ä¢ Add alt text to images for screen readers<br>' : ''}
                ${wcagIssues.some(i => i.type === 'missing-label') ? '‚Ä¢ Add labels to form inputs and buttons<br>' : ''}
                ${wcagIssues.some(i => i.type === 'missing-heading') ? '‚Ä¢ Fix heading hierarchy (h1 ‚Üí h2 ‚Üí h3)' : ''}
              </div>
            </div>
          </div>
        `;
      }

      function getConsoleContent() {
        if (consoleErrors.length === 0) {
          return `
            <div style="text-align: center; padding: 20px;">
              <div style="font-size: 32px; margin-bottom: 8px;">üìù</div>
              <div style="color: #9CA3AF; font-weight: 500;">No console messages</div>
              <div style="color: #6B7280; font-size: 11px; margin-top: 8px;">
                ${consoleMode ? 'Console mode enabled' : 'Capturing errors only'}
              </div>
              <button
                onclick="window.toggleConsoleMode()"
                style="
                  margin-top: 12px;
                  background: ${consoleMode ? '#10B981' : '#4B5563'};
                  border: none;
                  color: white;
                  padding: 6px 12px;
                  border-radius: 6px;
                  font-size: 11px;
                  cursor: pointer;
                  transition: all 0.2s;
                "
              >${consoleMode ? 'Console Mode ON' : 'Enable Console Mode'}</button>
              ${consoleMode ? `
                <div style="margin-top: 12px; padding: 10px; background: rgba(31, 41, 55, 0.5); border-radius: 6px; text-align: left;">
                  <div style="font-size: 10px; color: #60A5FA; margin-bottom: 6px;">Usage:</div>
                  <code style="font-size: 9px; color: #E5E7EB; display: block; margin-bottom: 4px;">
                    webVitalsLog.info('Info message')
                  </code>
                  <code style="font-size: 9px; color: #E5E7EB; display: block; margin-bottom: 4px;">
                    webVitalsLog.warn('Warning')
                  </code>
                  <code style="font-size: 9px; color: #E5E7EB; display: block;">
                    webVitalsLog.error('Error')
                  </code>
                </div>
              ` : ''}
            </div>
          `;
        }

        const typeColors = {
          'error': '#EF4444',
          'warn': '#F59E0B',
          'info': '#60A5FA'
        };

        const typeIcons = {
          'error': '‚ùå',
          'warn': '‚ö†Ô∏è',
          'info': '‚ÑπÔ∏è'
        };

        return `
          <div style="padding: 4px;">
            <div style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 8px;
              padding: 6px;
              background: rgba(31, 41, 55, 0.3);
              border-radius: 6px;
            ">
              <div style="display: flex; gap: 8px; align-items: center;">
                <span style="font-size: 11px; color: #9CA3AF;">
                  ${consoleErrors.length} message${consoleErrors.length !== 1 ? 's' : ''}
                </span>
                <button
                  onclick="window.clearConsoleErrors()"
                  style="
                    background: #4B5563;
                    border: none;
                    color: white;
                    padding: 2px 8px;
                    border-radius: 4px;
                    font-size: 10px;
                    cursor: pointer;
                  "
                >Clear</button>
              </div>
              <button
                onclick="window.toggleConsoleMode()"
                style="
                  background: ${consoleMode ? '#10B981' : '#4B5563'};
                  border: none;
                  color: white;
                  padding: 4px 10px;
                  border-radius: 4px;
                  font-size: 10px;
                  cursor: pointer;
                "
              >${consoleMode ? 'Mode: ON' : 'Mode: OFF'}</button>
            </div>
            <div style="max-height: 300px; overflow-y: auto;">
              ${consoleErrors.slice(-50).reverse().map(log => `
                <div style="
                  margin-bottom: 6px;
                  padding: 8px;
                  background: rgba(31, 41, 55, 0.5);
                  border-radius: 6px;
                  border-left: 3px solid ${typeColors[log.type] || '#6B7280'};
                  font-size: 11px;
                ">
                  <div style="
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                    margin-bottom: 4px;
                  ">
                    <span style="color: ${typeColors[log.type] || '#6B7280'};">
                      ${typeIcons[log.type] || 'üìù'} ${log.type.toUpperCase()}
                    </span>
                    <span style="color: #6B7280; font-size: 9px;">
                      ${new Date(log.timestamp).toLocaleTimeString()}
                    </span>
                  </div>
                  <div style="
                    color: #E5E7EB;
                    word-wrap: break-word;
                    font-family: 'SF Mono', Monaco, monospace;
                    white-space: pre-wrap;
                  ">${log.message}</div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      function getDetailsContent() {
        let content = '<div style="padding: 8px;">';

        // Page Info
        content += `
          <div style="margin-bottom: 16px;">
            <div style="font-weight: 500; color: #60A5FA; margin-bottom: 8px; font-size: 11px;">üìä Session Info</div>
            <div style="padding: 8px; background: rgba(31, 41, 55, 0.5); border-radius: 6px; font-size: 10px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="color: #9CA3AF;">URL</span>
                <span style="color: #E5E7EB; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${window.location.pathname}</span>
              </div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span style="color: #9CA3AF;">Viewport</span>
                <span style="color: #E5E7EB;">${window.innerWidth} √ó ${window.innerHeight}</span>
              </div>
              ${sampleRate < 1 ? `
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: #9CA3AF;">Sampling Rate</span>
                  <span style="color: #E5E7EB;">${(sampleRate * 100).toFixed(0)}%</span>
                </div>
              ` : ''}
            </div>
          </div>
        `;

        // Extended metrics
        if (extendedMetrics && performance.memory) {
          const used = (performance.memory.usedJSHeapSize / 1048576).toFixed(1);
          const total = (performance.memory.totalJSHeapSize / 1048576).toFixed(1);
          const percent = ((performance.memory.usedJSHeapSize / performance.memory.totalJSHeapSize) * 100).toFixed(0);

          content += `
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 500; color: #60A5FA; margin-bottom: 8px; font-size: 11px;">üíæ Memory</div>
              <div style="padding: 8px; background: rgba(31, 41, 55, 0.5); border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 4px;">
                  <span style="color: #9CA3AF;">JS Heap</span>
                  <span style="color: #E5E7EB;">${used} / ${total} MB (${percent}%)</span>
                </div>
                <div style="height: 4px; background: rgba(255, 255, 255, 0.1); border-radius: 2px; overflow: hidden;">
                  <div style="height: 100%; width: ${percent}%; background: ${percent < 70 ? '#10B981' : percent < 90 ? '#F59E0B' : '#EF4444'};"></div>
                </div>
              </div>
            </div>
          `;
        }

        if (navigator.connection) {
          const conn = navigator.connection;
          const connectionQuality = conn.effectiveType === '4g' ? 'üü¢' :
                                   conn.effectiveType === '3g' ? 'üü°' :
                                   conn.effectiveType === '2g' ? 'üü†' : 'üî¥';

          content += `
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 500; color: #60A5FA; margin-bottom: 8px; font-size: 11px;">üåê Network</div>
              <div style="padding: 8px; background: rgba(31, 41, 55, 0.5); border-radius: 6px; font-size: 10px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                  <span style="color: #9CA3AF;">Connection</span>
                  <span style="color: #E5E7EB;">${connectionQuality} ${conn.effectiveType || 'unknown'}</span>
                </div>
                ${conn.rtt ? `
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="color: #9CA3AF;">Latency</span>
                    <span style="color: #E5E7EB;">${conn.rtt}ms</span>
                  </div>
                ` : ''}
                ${conn.downlink ? `
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: #9CA3AF;">Speed</span>
                    <span style="color: #E5E7EB;">${conn.downlink} Mbps</span>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }

        // Config info
        if (endpoint || batchReporting) {
          content += `
            <div style="margin-bottom: 16px;">
              <div style="font-weight: 500; color: #60A5FA; margin-bottom: 8px; font-size: 11px;">‚öôÔ∏è Configuration</div>
              <div style="padding: 8px; background: rgba(31, 41, 55, 0.5); border-radius: 6px; font-size: 10px;">
                ${endpoint ? `
                  <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                    <span style="color: #9CA3AF;">Analytics</span>
                    <span style="color: #10B981;">‚úÖ Active</span>
                  </div>
                ` : ''}
                ${batchReporting ? `
                  <div style="display: flex; justify-content: space-between;">
                    <span style="color: #9CA3AF;">Batching</span>
                    <span style="color: #E5E7EB;">Every ${batchInterval/1000}s</span>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        }

        content += '</div>';
        return content;
      }

      // Global functions for overlay interaction
      window.toggleWebVitalsDebug = function() {
        isExpanded = !isExpanded;
        updateDebugOverlay();
      };

      window.setWebVitalsTab = function(tab) {
        activeTab = tab;
        updateDebugOverlay();
      };

      window.toggleConsoleMode = function() {
        consoleMode = !consoleMode;
        updateDebugOverlay();
      };

      window.clearConsoleErrors = function() {
        consoleErrors.length = 0;
        updateDebugOverlay();
      };

      window.toggleAccessibilityIssue = function(type) {
        if (expandedIssues.has(type)) {
          expandedIssues.delete(type);
        } else {
          expandedIssues.add(type);
        }
        updateDebugOverlay();
      };

      // WCAG Checker
      function checkWCAG() {
        if (!checkAccessibility) return;

        wcagIssues.length = 0;

        // Check for missing alt text
        document.querySelectorAll('img:not([alt])').forEach(img => {
          wcagIssues.push({
            type: 'missing-alt',
            element: img.src ? `<img src="${img.src.substring(0, 50)}...">` : '<img>',
            message: 'Image missing alt attribute',
            wcagLevel: '1.1.1 Level A'
          });
        });

        // Check for empty buttons
        document.querySelectorAll('button').forEach(button => {
          if (!button.textContent.trim() && !button.getAttribute('aria-label')) {
            wcagIssues.push({
              type: 'missing-label',
              element: '<button>',
              message: 'Button has no accessible text',
              wcagLevel: '4.1.2 Level A'
            });
          }
        });

        // Check form inputs without labels
        document.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(input => {
          const id = input.id;
          const hasLabel = id && document.querySelector(`label[for="${id}"]`);
          const hasAriaLabel = input.getAttribute('aria-label');

          if (!hasLabel && !hasAriaLabel) {
            wcagIssues.push({
              type: 'missing-label',
              element: `<${input.tagName.toLowerCase()} type="${input.type || 'text'}">`,
              message: 'Form control missing label',
              wcagLevel: '1.3.1 Level A'
            });
          }
        });

        // Check heading structure
        const headings = Array.from(document.querySelectorAll('h1, h2, h3, h4, h5, h6'));
        let lastLevel = 0;
        headings.forEach(heading => {
          const level = parseInt(heading.tagName[1]);
          if (level - lastLevel > 1) {
            wcagIssues.push({
              type: 'missing-heading',
              element: `<${heading.tagName.toLowerCase()}>`,
              message: `Heading level skipped (${lastLevel} to ${level})`,
              wcagLevel: '1.3.1 Level A'
            });
          }
          lastLevel = level;
        });

        // Check for links without text
        document.querySelectorAll('a[href]').forEach(link => {
          if (!link.textContent.trim() && !link.getAttribute('aria-label')) {
            wcagIssues.push({
              type: 'missing-label',
              element: `<a href="${link.href.substring(0, 30)}...">`,
              message: 'Link has no accessible text',
              wcagLevel: '2.4.4 Level A'
            });
          }
        });

        updateDebugOverlay();
      }

      // Core Web Vitals measurements
      function measureLCP() {
        try {
          let lcpTimeout;
          const observer = new PerformanceObserver((list) => {
            const entries = list.getEntries();
            const lastEntry = entries[entries.length - 1];
            vitals.LCP = Math.round(lastEntry.startTime);
            recordMetric('LCP', vitals.LCP);
            updateDebugOverlay();

            // Reset timeout on each new LCP
            if (lcpTimeout) clearTimeout(lcpTimeout);
            lcpTimeout = setTimeout(() => {
              // Finalize LCP after 3 seconds of no changes
              observer.disconnect();
              if (debug) console.log('[@casoon/astro-webvitals] LCP finalized at:', vitals.LCP);
            }, 3000);
          });
          observer.observe({ type: 'largest-contentful-paint', buffered: true });

          // Also disconnect on page hide
          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
              observer.disconnect();
            }
          });
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] LCP not supported');
        }
      }

      function measureFID() {
        try {
          const observer = new PerformanceObserver((list) => {
            const firstEntry = list.getEntries()[0];
            vitals.FID = Math.round(firstEntry.processingStart - firstEntry.startTime);
            recordMetric('FID', vitals.FID);
            updateDebugOverlay();
            observer.disconnect();
          });
          observer.observe({ type: 'first-input', buffered: true });
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] FID not supported');
        }
      }

      function measureCLS() {
        try {
          let clsValue = 0;
          let sessionValue = 0;
          let sessionEntries = [];

          const observer = new PerformanceObserver((list) => {
            for (const entry of list.getEntries()) {
              if (!entry.hadRecentInput) {
                const firstSessionEntry = sessionEntries[0];
                const lastSessionEntry = sessionEntries[sessionEntries.length - 1];

                if (sessionValue && entry.startTime - lastSessionEntry.startTime > 1000) {
                  sessionValue = 0;
                  sessionEntries = [];
                }

                sessionEntries.push(entry);
                sessionValue += entry.value;

                if (sessionValue > clsValue) {
                  clsValue = sessionValue;
                  vitals.CLS = Math.round(clsValue * 1000) / 1000;
                  recordMetric('CLS', vitals.CLS);
                  updateDebugOverlay();
                }
              }
            }
          });
          observer.observe({ type: 'layout-shift', buffered: true });

          document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'hidden') {
              observer.disconnect();
            }
          });
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] CLS not supported');
        }
      }

      function measureFCP() {
        try {
          const observer = new PerformanceObserver((list) => {
            const entries = list.getEntries();
            const fcpEntry = entries.find(entry => entry.name === 'first-contentful-paint');
            if (fcpEntry) {
              vitals.FCP = Math.round(fcpEntry.startTime);
              recordMetric('FCP', vitals.FCP);
              updateDebugOverlay();
              observer.disconnect();
            }
          });
          observer.observe({ type: 'paint', buffered: true });
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] FCP not supported');
        }
      }

      function measureTTFB() {
        try {
          const navigationEntry = performance.getEntriesByType('navigation')[0];
          if (navigationEntry) {
            // Correct TTFB calculation: from fetch start to response start
            vitals.TTFB = Math.round(navigationEntry.responseStart - navigationEntry.fetchStart);
            recordMetric('TTFB', vitals.TTFB);
            updateDebugOverlay();
          }
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] TTFB not supported');
        }
      }

      // New metric: DNS Resolution Time
      function measureDNS() {
        try {
          const navEntry = performance.getEntriesByType('navigation')[0];
          if (navEntry && navEntry.domainLookupEnd > navEntry.domainLookupStart) {
            vitals.DNS = Math.round(navEntry.domainLookupEnd - navEntry.domainLookupStart);
            recordMetric('DNS', vitals.DNS);
            updateDebugOverlay();
          }
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] DNS not available');
        }
      }

      // New metric: TCP Connection Time
      function measureTCP() {
        try {
          const navEntry = performance.getEntriesByType('navigation')[0];
          if (navEntry && navEntry.connectEnd > navEntry.connectStart) {
            vitals.TCP = Math.round(navEntry.connectEnd - navEntry.connectStart);
            recordMetric('TCP', vitals.TCP);
            updateDebugOverlay();
          }
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] TCP not available');
        }
      }

      // New metric: DOM Processing Time
      function measureDOM() {
        try {
          const navEntry = performance.getEntriesByType('navigation')[0];
          if (navEntry && navEntry.domInteractive > navEntry.responseEnd) {
            vitals.DOM = Math.round(navEntry.domInteractive - navEntry.responseEnd);
            recordMetric('DOM', vitals.DOM);
            updateDebugOverlay();
          }
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] DOM not available');
        }
      }

      // New metric: Page Load Complete Time
      function measureLOAD() {
        try {
          const navEntry = performance.getEntriesByType('navigation')[0];
          if (navEntry && navEntry.loadEventEnd > 0) {
            vitals.LOAD = Math.round(navEntry.loadEventEnd - navEntry.navigationStart);
            recordMetric('LOAD', vitals.LOAD);
            updateDebugOverlay();
          }
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] LOAD not available');
        }
      }

      function measureINP() {
        try {
          let maxDelay = 0;
          const observer = new PerformanceObserver((list) => {
            const entries = list.getEntries();
            entries.forEach((entry) => {
              const delay = entry.processingStart - entry.startTime;
              if (delay > maxDelay) {
                maxDelay = delay;
                vitals.INP = Math.round(maxDelay);
                recordMetric('INP', vitals.INP);
                updateDebugOverlay();
              }
            });
          });
          observer.observe({ type: 'event', buffered: true });
        } catch (e) {
          if (debug) console.warn('[@casoon/astro-webvitals] INP not supported');
        }
      }

      // Batch reporting logic
      function recordMetric(name, value) {
        const metric = {
          name,
          value,
          timestamp: Date.now()
        };

        if (batchReporting) {
          metricsBuffer.push(metric);

          if (metricsBuffer.length >= 10 || !batchTimer) {
            if (batchTimer) clearTimeout(batchTimer);
            batchTimer = setTimeout(flushMetrics, batchInterval);
          }
        } else {
          sendMetrics(metric);
        }
      }

      function flushMetrics() {
        if (metricsBuffer.length === 0) return;
        sendMetrics([...metricsBuffer]);
        metricsBuffer.length = 0;
        if (batchTimer) {
          clearTimeout(batchTimer);
          batchTimer = null;
        }
      }

      function sendMetrics(metrics) {
        if (!endpoint) return;

        const payload = {
          metrics: Array.isArray(metrics) ? metrics : [metrics],
          sessionId: sessionId,
          userId: userId,
          timestamp: Date.now(),
          url: window.location.href,
          userAgent: navigator.userAgent
        };

        fetch(endpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...headers
          },
          body: JSON.stringify(payload),
          keepalive: true
        }).catch(err => {
          if (debug) console.warn('[@casoon/astro-webvitals] Failed to send metrics:', err);
        });
      }

      // Initialize all measurements
      // Navigation timing metrics (available immediately)
      measureDNS();
      measureTCP();
      measureTTFB();
      measureDOM();

      // Paint metrics
      measureFCP();
      measureLCP();

      // Interaction metrics
      measureFID();
      measureINP();
      measureCLS();

      // Load complete (might take a while)
      if (document.readyState === 'complete') {
        measureLOAD();
      } else {
        window.addEventListener('load', measureLOAD);
      }

      // Check accessibility after DOM is ready
      if (checkAccessibility) {
        if (document.readyState === 'complete') {
          setTimeout(checkWCAG, 1000);
        } else {
          window.addEventListener('load', () => setTimeout(checkWCAG, 1000));
        }
      }

      // Flush on page unload
      window.addEventListener('beforeunload', flushMetrics);

      if (debug) {
        setTimeout(() => updateDebugOverlay(), 100);
        // Update periodically
        setInterval(() => {
          if (checkAccessibility && isExpanded && activeTab === 'accessibility') {
            checkWCAG();
          }
          updateDebugOverlay();
        }, 5000);
      }
    })();
  </script>
)}
